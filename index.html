<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School ERP - Offline Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <style>
        /* ===== CSS Variables ===== */
        :root {
            --primary-color: #4a6fa5;
            --primary-dark: #385d8a;
            --primary-light: #6b8cbc;
            --secondary-color: #66bb6a;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
            --success-color: #4caf50;
            
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-light: #888888;
            
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-sidebar: #2c3e50;
            --bg-header: #ffffff;
            
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 5px 20px rgba(0, 0, 0, 0.15);
            
            --sidebar-width: 250px;
            --sidebar-collapsed-width: 70px;
            --header-height: 70px;
            
            --border-radius: 8px;
            --border-radius-sm: 4px;
            
            --transition: all 0.3s ease;
        }

        /* Dark mode variables */
        .dark-mode {
            --primary-color: #5d8cc7;
            --primary-dark: #4a6fa5;
            --primary-light: #7a9fd6;
            
            --text-primary: #f0f0f0;
            --text-secondary: #cccccc;
            --text-light: #aaaaaa;
            
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-sidebar: #1a252f;
            --bg-header: #1e1e1e;
            
            --border-color: #333333;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        /* ===== Base Styles ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
            overflow-x: hidden;
        }

        /* ===== Lock Screen ===== */
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }

        .lock-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: var(--border-radius);
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .lock-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: white;
        }

        .lock-container h2 {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .lock-container p {
            margin-bottom: 1.5rem;
            opacity: 0.9;
        }

        .pin-input input {
            width: 100%;
            padding: 1rem;
            font-size: 1.5rem;
            text-align: center;
            border: none;
            border-radius: var(--border-radius);
            background: rgba(255, 255, 255, 0.9);
            margin-bottom: 1.5rem;
            letter-spacing: 0.5rem;
        }

        .pin-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .note {
            font-size: 0.8rem;
            margin-top: 1.5rem;
            opacity: 0.8;
        }

        /* ===== Main App Container ===== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== Header ===== */
        .app-header {
            height: var(--header-height);
            background-color: var(--bg-header);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: var(--transition);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background-color: var(--bg-primary);
        }

        .school-info h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .school-info p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .datetime {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .icon-btn:hover {
            background-color: var(--bg-primary);
            color: var(--primary-color);
        }

        /* ===== Sidebar ===== */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: var(--header-height);
            left: 0;
            height: calc(100vh - var(--header-height));
            transition: var(--transition);
            z-index: 99;
            box-shadow: var(--shadow);
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .sidebar-nav {
            flex: 1;
            padding: 1.5rem 0;
            overflow-y: auto;
        }

        .sidebar-nav ul {
            list-style: none;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--primary-light);
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border-left-color: var(--primary-color);
        }

        .nav-link i {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .sidebar.collapsed .nav-link span {
            display: none;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
        }

        .storage-info {
            margin-bottom: 1rem;
        }

        .storage-bar {
            height: 6px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .storage-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 30%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .offline-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* ===== Main Content ===== */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 1.5rem;
            overflow-y: auto;
            transition: var(--transition);
            background-color: var(--bg-primary);
        }

        .sidebar.collapsed + .main-content {
            margin-left: var(--sidebar-collapsed-width);
        }

        /* ===== Page Styles ===== */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .page-actions {
            display: flex;
            gap: 1rem;
        }

        /* ===== Buttons ===== */
        .btn {
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--bg-primary);
            border-color: var(--primary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #f57c00;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        /* ===== Cards ===== */
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .card-icon.students { background-color: #4a6fa5; }
        .card-icon.teachers { background-color: #66bb6a; }
        .card-icon.classes { background-color: #ff9800; }
        .card-icon.attendance { background-color: #2196f3; }
        .card-icon.fees { background-color: #9c27b0; }
        .card-icon.notices { background-color: #f44336; }

        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .card-change {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .card-change.positive { color: var(--success-color); }
        .card-change.negative { color: var(--danger-color); }

        /* ===== Tables ===== */
        .table-container {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 0.7rem 1rem 0.7rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            width: 250px;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background-color: var(--bg-primary);
            border-bottom: 2px solid var(--border-color);
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        tbody tr {
            transition: var(--transition);
        }

        tbody tr:hover {
            background-color: var(--bg-primary);
        }

        /* ===== Badges ===== */
        .badge {
            display: inline-block;
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-success {
            background-color: rgba(76, 175, 80, 0.15);
            color: var(--success-color);
        }

        .badge-danger {
            background-color: rgba(244, 67, 54, 0.15);
            color: var(--danger-color);
        }

        .badge-warning {
            background-color: rgba(255, 152, 0, 0.15);
            color: var(--warning-color);
        }

        .badge-info {
            background-color: rgba(33, 150, 243, 0.15);
            color: var(--info-color);
        }

        .badge-primary {
            background-color: rgba(74, 111, 165, 0.15);
            color: var(--primary-color);
        }

        /* ===== Modals ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background-color: var(--bg-primary);
            color: var(--danger-color);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* ===== Forms ===== */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* ===== Toast Notifications ===== */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid var(--primary-color);
        }

        .toast.success {
            border-left-color: var(--success-color);
        }

        .toast.error {
            border-left-color: var(--danger-color);
        }

        .toast.warning {
            border-left-color: var(--warning-color);
        }

        .toast.info {
            border-left-color: var(--info-color);
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast.success .toast-icon { color: var(--success-color); }
        .toast.error .toast-icon { color: var(--danger-color); }
        .toast.warning .toast-icon { color: var(--warning-color); }
        .toast.info .toast-icon { color: var(--info-color); }

        .toast-message {
            flex: 1;
            font-weight: 500;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* ===== Profile Page ===== */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding: 2rem;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            font-weight: 700;
        }

        .profile-info h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .profile-info p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .profile-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .tab-btn {
            padding: 1rem 2rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .tab-btn:hover {
            color: var(--primary-color);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== Attendance Grid ===== */
        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .attendance-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
            border: 2px solid transparent;
        }

        .attendance-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .attendance-card.present {
            border-color: var(--success-color);
        }

        .attendance-card.absent {
            border-color: var(--danger-color);
        }

        .attendance-card.selected.present {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .attendance-card.selected.absent {
            background-color: rgba(244, 67, 54, 0.1);
        }

        .attendance-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            margin-bottom: 0.5rem;
        }

        .attendance-name {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .attendance-status {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
        }

        /* ===== Timetable ===== */
        .timetable {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .timetable th {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
        }

        .timetable td {
            padding: 1rem;
            border: 1px solid var(--border-color);
            text-align: center;
            vertical-align: top;
        }

        .timetable-period {
            font-weight: 600;
            color: var(--primary-color);
        }

        .timetable-subject {
            font-weight: 500;
            margin-bottom: 0.3rem;
            color: var(--text-primary);
        }

        .timetable-teacher {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* ===== Notice Board ===== */
        .notices-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .notice-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .notice-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .notice-card.important {
            border-left-color: var(--danger-color);
        }

        .notice-card.warning {
            border-left-color: var(--warning-color);
        }

        .notice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .notice-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .notice-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .notice-content {
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* ===== Settings Page ===== */
        .settings-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .settings-nav {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .settings-nav ul {
            list-style: none;
        }

        .settings-nav li {
            margin-bottom: 0.5rem;
        }

        .settings-nav a {
            display: block;
            padding: 0.8rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .settings-nav a:hover {
            background-color: var(--bg-primary);
        }

        .settings-nav a.active {
            background-color: var(--primary-color);
            color: white;
        }

        .settings-content {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        /* ===== Pagination ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .pagination-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-pages {
            display: flex;
            gap: 0.3rem;
        }

        .page-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .page-btn:hover {
            background-color: var(--bg-primary);
        }

        .page-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* ===== Fee Structure ===== */
        .fee-structure-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .fee-structure-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: left;
        }

        .fee-structure-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .fee-amount {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* ===== Exam Results ===== */
        .exam-results-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .exam-results-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: left;
        }

        .exam-results-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .result-grade {
            font-weight: 600;
            padding: 0.3rem 0.7rem;
            border-radius: 20px;
        }

        .grade-a { background-color: rgba(76, 175, 80, 0.15); color: var(--success-color); }
        .grade-b { background-color: rgba(33, 150, 243, 0.15); color: var(--info-color); }
        .grade-c { background-color: rgba(255, 152, 0, 0.15); color: var(--warning-color); }
        .grade-d { background-color: rgba(244, 67, 54, 0.15); color: var(--danger-color); }
        .grade-f { background-color: rgba(158, 158, 158, 0.15); color: var(--text-secondary); }

        /* ===== Responsive ===== */
        @media (max-width: 992px) {
            .settings-container {
                grid-template-columns: 1fr;
            }
            
            .cards-container {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: var(--sidebar-width);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .header-right {
                gap: 1rem;
            }
            
            .school-info h1 {
                font-size: 1.2rem;
            }
            
            .search-box input {
                width: 200px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .attendance-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .modal {
                margin: 1rem;
                width: calc(100% - 2rem) !important;
            }
        }

        @media (max-width: 576px) {
            .app-header {
                padding: 0 1rem;
            }
            
            .header-right {
                flex-direction: column;
                align-items: flex-end;
                gap: 0.5rem;
            }
            
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .table-controls {
                width: 100%;
            }
            
            .search-box input {
                width: 100%;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .attendance-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .form-control, .btn {
                font-size: 16px !important;
            }
        }
        
        /* Additional fixes */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .form-control:invalid {
            border-color: var(--danger-color);
        }
        
        .form-control:valid {
            border-color: var(--success-color);
        }
        
        /* New fixes */
        .form-check {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .form-check-input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .form-check-label {
            cursor: pointer;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-active { background-color: var(--success-color); }
        .status-inactive { background-color: var(--danger-color); }
        .status-pending { background-color: var(--warning-color); }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- PIN Lock Screen -->
    <div id="lockScreen" class="lock-screen">
        <div class="lock-container">
            <div class="lock-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h2>School ERP - Secure Access</h2>
            <p>Enter PIN to access the system</p>
            <div class="pin-input">
                <input type="password" id="pinField" maxlength="4" placeholder="Enter 4-digit PIN" autofocus>
            </div>
            <div class="pin-buttons">
                <button class="btn-primary" id="unlockBtn">Unlock</button>
                <button class="btn-secondary" id="resetPinBtn">Reset PIN</button>
            </div>
            <p class="note">Default PIN: 1234 (You can change it in Settings)</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="school-info">
                    <h1 id="schoolName">Greenwood High School</h1>
                    <p id="academicYear">Academic Year: 2023-2024</p>
                </div>
            </div>
            <div class="header-right">
                <div class="datetime" id="currentDateTime">
                    <!-- Will be updated by JS -->
                </div>
                <div class="header-actions">
                    <button class="icon-btn" id="themeToggle" title="Toggle Dark Mode">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="icon-btn" id="exportBtn" title="Export Data">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="icon-btn" id="importBtn" title="Import Data">
                        <i class="fas fa-upload"></i>
                    </button>
                    <button class="icon-btn" id="settingsBtn" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="icon-btn" id="lockBtn" title="Lock System">
                        <i class="fas fa-lock"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <ul>
                    <li>
                        <a href="#dashboard" class="nav-link active" data-page="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#students" class="nav-link" data-page="students">
                            <i class="fas fa-user-graduate"></i>
                            <span>Students</span>
                        </a>
                    </li>
                    <li>
                        <a href="#teachers" class="nav-link" data-page="teachers">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Teachers</span>
                        </a>
                    </li>
                    <li>
                        <a href="#classes" class="nav-link" data-page="classes">
                            <i class="fas fa-school"></i>
                            <span>Classes</span>
                        </a>
                    </li>
                    <li>
                        <a href="#attendance" class="nav-link" data-page="attendance">
                            <i class="fas fa-clipboard-check"></i>
                            <span>Attendance</span>
                        </a>
                    </li>
                    <li>
                        <a href="#exams" class="nav-link" data-page="exams">
                            <i class="fas fa-file-alt"></i>
                            <span>Exams & Results</span>
                        </a>
                    </li>
                    <li>
                        <a href="#fees" class="nav-link" data-page="fees">
                            <i class="fas fa-money-check-alt"></i>
                            <span>Fee Management</span>
                        </a>
                    </li>
                    <li>
                        <a href="#timetable" class="nav-link" data-page="timetable">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Timetable</span>
                        </a>
                    </li>
                    <li>
                        <a href="#notices" class="nav-link" data-page="notices">
                            <i class="fas fa-bullhorn"></i>
                            <span>Notice Board</span>
                        </a>
                    </li>
                    <li>
                        <a href="#settings" class="nav-link" data-page="settings">
                            <i class="fas fa-cogs"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="storage-info">
                    <div class="storage-bar">
                        <div class="storage-fill" id="storageFill"></div>
                    </div>
                    <small>Local Storage: <span id="storageUsed">0</span> KB used</small>
                </div>
                <div class="offline-status">
                    <i class="fas fa-wifi-slash"></i>
                    <span>Offline Mode</span>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <!-- Pages will be dynamically loaded here -->
            <div class="page active" id="dashboardPage"></div>
            <div class="page" id="studentsPage"></div>
            <div class="page" id="teachersPage"></div>
            <div class="page" id="classesPage"></div>
            <div class="page" id="attendancePage"></div>
            <div class="page" id="examsPage"></div>
            <div class="page" id="feesPage"></div>
            <div class="page" id="timetablePage"></div>
            <div class="page" id="noticesPage"></div>
            <div class="page" id="settingsPage"></div>
        </main>

        <!-- Modals will be appended here dynamically -->
        <div id="modalContainer"></div>

        <!-- Toast notifications -->
        <div id="toastContainer" class="toast-container"></div>
    </div>

    <script>
        // ============================================
        // FIXED Storage Management System
        // ============================================
        class SchoolERPStorage {
            constructor() {
                this.initStorage();
            }
            
            initStorage() {
                // Initialize all storage keys with default values if they don't exist
                const defaults = {
                    settings: {
                        schoolName: "Greenwood High School",
                        academicYear: "2023-2024",
                        theme: "light",
                        pin: "1234",
                        autoLock: true,
                        autoLockMinutes: 15
                    },
                    students: [],
                    teachers: [],
                    classes: [],
                    subjects: [],
                    attendance: [],
                    exams: [],
                    results: [],
                    fees: [],
                    feeStructure: [],
                    timetable: [],
                    notices: []
                };
                
                for (const [key, value] of Object.entries(defaults)) {
                    if (!this.get(key)) {
                        this.set(key, value);
                    }
                }
                
                // Initialize sample data
                this.initSampleData();
                
                // Update storage usage display
                this.updateStorageUsage();
            }
            
            get(key) {
                try {
                    const item = localStorage.getItem(`schoolERP_${key}`);
                    return item ? JSON.parse(item) : null;
                } catch (error) {
                    console.error(`Error getting ${key} from storage:`, error);
                    return null;
                }
            }
            
            set(key, value) {
                try {
                    localStorage.setItem(`schoolERP_${key}`, JSON.stringify(value));
                    this.updateStorageUsage();
                    return true;
                } catch (error) {
                    console.error(`Error setting ${key} in storage:`, error);
                    this.showStorageError();
                    return false;
                }
            }
            
            updateStorageUsage() {
                let totalBytes = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('schoolERP_')) {
                        const value = localStorage.getItem(key);
                        if (value) {
                            totalBytes += new Blob([value]).size;
                        }
                    }
                }
                
                const usedKB = Math.round(totalBytes / 1024);
                const maxKB = 5120; // 5MB limit
                const percentage = Math.min((usedKB / maxKB) * 100, 100);
                
                const fillElement = document.getElementById('storageFill');
                const usedElement = document.getElementById('storageUsed');
                
                if (fillElement) {
                    fillElement.style.width = `${percentage}%`;
                }
                
                if (usedElement) {
                    usedElement.textContent = usedKB;
                }
                
                if (fillElement) {
                    if (percentage > 90) {
                        fillElement.style.backgroundColor = 'var(--danger-color)';
                    } else if (percentage > 70) {
                        fillElement.style.backgroundColor = 'var(--warning-color)';
                    } else {
                        fillElement.style.backgroundColor = 'var(--primary-color)';
                    }
                }
            }
            
            showStorageError() {
                if (window.showToast) {
                    window.showToast({
                        type: 'error',
                        message: 'Storage is full! Please export your data and clear browser data.',
                        duration: 5000
                    });
                }
            }
            
            exportData() {
                const data = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('schoolERP_')) {
                        const cleanKey = key.replace('schoolERP_', '');
                        try {
                            data[cleanKey] = JSON.parse(localStorage.getItem(key));
                        } catch (e) {
                            console.error(`Error parsing ${key}:`, e);
                        }
                    }
                }
                
                data.exportDate = new Date().toISOString();
                data.appVersion = "1.0.0";
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `school-erp-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                return true;
            }
            
            importData(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            if (!data.settings) {
                                throw new Error('Invalid backup file format');
                            }
                            
                            // Clear existing data
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key.startsWith('schoolERP_')) {
                                    localStorage.removeItem(key);
                                }
                            }
                            
                            // Import new data
                            for (const [key, value] of Object.entries(data)) {
                                this.set(key, value);
                            }
                            
                            resolve(true);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                });
            }
            
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }
            
            // Student methods
            getStudents() {
                return this.get('students') || [];
            }
            
            saveStudent(student) {
                const students = this.getStudents();
                if (student.id) {
                    const index = students.findIndex(s => s.id === student.id);
                    if (index !== -1) {
                        students[index] = student;
                    }
                } else {
                    student.id = this.generateId();
                    student.admissionNo = student.admissionNo || `STU${String(students.length + 1).padStart(4, '0')}`;
                    student.createdAt = new Date().toISOString();
                    students.push(student);
                }
                
                return this.set('students', students);
            }
            
            deleteStudent(id) {
                const students = this.getStudents();
                const filtered = students.filter(s => s.id !== id);
                return this.set('students', filtered);
            }
            
            // Teacher methods
            getTeachers() {
                return this.get('teachers') || [];
            }
            
            saveTeacher(teacher) {
                const teachers = this.getTeachers();
                if (teacher.id) {
                    const index = teachers.findIndex(t => t.id === teacher.id);
                    if (index !== -1) {
                        teachers[index] = teacher;
                    }
                } else {
                    teacher.id = this.generateId();
                    teacher.employeeId = teacher.employeeId || `TCH${String(teachers.length + 1).padStart(4, '0')}`;
                    teacher.createdAt = new Date().toISOString();
                    teachers.push(teacher);
                }
                
                return this.set('teachers', teachers);
            }
            
            deleteTeacher(id) {
                const teachers = this.getTeachers();
                const filtered = teachers.filter(t => t.id !== id);
                return this.set('teachers', filtered);
            }
            
            // Class methods
            getClasses() {
                return this.get('classes') || [];
            }
            
            saveClass(cls) {
                const classes = this.getClasses();
                if (cls.id) {
                    const index = classes.findIndex(c => c.id === cls.id);
                    if (index !== -1) {
                        classes[index] = cls;
                    }
                } else {
                    cls.id = this.generateId();
                    cls.createdAt = new Date().toISOString();
                    classes.push(cls);
                }
                
                return this.set('classes', classes);
            }
            
            deleteClass(id) {
                const classes = this.getClasses();
                const filtered = classes.filter(c => c.id !== id);
                return this.set('classes', filtered);
            }
            
            // Subject methods
            getSubjects() {
                return this.get('subjects') || [];
            }
            
            saveSubject(subject) {
                const subjects = this.getSubjects();
                if (subject.id) {
                    const index = subjects.findIndex(s => s.id === subject.id);
                    if (index !== -1) {
                        subjects[index] = subject;
                    }
                } else {
                    subject.id = this.generateId();
                    subject.createdAt = new Date().toISOString();
                    subjects.push(subject);
                }
                
                return this.set('subjects', subjects);
            }
            
            deleteSubject(id) {
                const subjects = this.getSubjects();
                const filtered = subjects.filter(s => s.id !== id);
                return this.set('subjects', filtered);
            }
            
            // Attendance methods
            getAttendance() {
                return this.get('attendance') || [];
            }
            
            getAttendanceForClass(date, className, section) {
                const allAttendance = this.getAttendance();
                return allAttendance.find(a => 
                    a.date === date && 
                    a.class == className && 
                    a.section === section
                );
            }
            
            saveAttendance(attendance) {
                const allAttendance = this.getAttendance();
                attendance.id = attendance.id || this.generateId();
                attendance.date = attendance.date || new Date().toISOString().split('T')[0];
                attendance.createdAt = new Date().toISOString();
                
                if (attendance.students) {
                    attendance.students = attendance.students.map(student => ({
                        studentId: student.studentId || student.id,
                        id: student.studentId || student.id,
                        name: student.name || '',
                        rollNo: student.rollNo || '',
                        status: student.status || 'absent'
                    }));
                }
                
                const filtered = allAttendance.filter(a => 
                    !(a.date === attendance.date && 
                      a.class == attendance.class && 
                      a.section === attendance.section)
                );
                
                filtered.push(attendance);
                return this.set('attendance', filtered);
            }
            
            // Exam methods
            getExams() {
                return this.get('exams') || [];
            }
            
            saveExam(exam) {
                const exams = this.getExams();
                if (exam.id) {
                    const index = exams.findIndex(e => e.id === exam.id);
                    if (index !== -1) {
                        exams[index] = exam;
                    }
                } else {
                    exam.id = this.generateId();
                    exam.createdAt = new Date().toISOString();
                    exams.push(exam);
                }
                
                return this.set('exams', exams);
            }
            
            deleteExam(id) {
                const exams = this.getExams();
                const filtered = exams.filter(e => e.id !== id);
                return this.set('exams', filtered);
            }
            
            // Result methods
            getResults() {
                return this.get('results') || [];
            }
            
            saveResult(result) {
                const results = this.getResults();
                if (result.id) {
                    const index = results.findIndex(r => r.id === result.id);
                    if (index !== -1) {
                        results[index] = result;
                    }
                } else {
                    result.id = this.generateId();
                    result.createdAt = new Date().toISOString();
                    result.marksObtained = parseFloat(result.marksObtained) || 0;
                    result.maxMarks = parseFloat(result.maxMarks) || 100;
                    results.push(result);
                }
                
                return this.set('results', results);
            }
            
            // Fee methods
            getFees() {
                return this.get('fees') || [];
            }
            
            saveFee(fee) {
                const fees = this.getFees();
                if (fee.id) {
                    const index = fees.findIndex(f => f.id === fee.id);
                    if (index !== -1) {
                        fees[index] = fee;
                    }
                } else {
                    fee.id = this.generateId();
                    fee.createdAt = new Date().toISOString();
                    fee.amount = parseFloat(fee.amount) || 0;
                    fees.push(fee);
                }
                
                return this.set('fees', fees);
            }
            
            deleteFee(id) {
                const fees = this.getFees();
                const filtered = fees.filter(f => f.id !== id);
                return this.set('fees', filtered);
            }
            
            // Fee structure methods
            getFeeStructure() {
                return this.get('feeStructure') || [];
            }
            
            saveFeeStructure(feeStructure) {
                const structures = this.getFeeStructure();
                if (feeStructure.id) {
                    const index = structures.findIndex(f => f.id === feeStructure.id);
                    if (index !== -1) {
                        structures[index] = feeStructure;
                    }
                } else {
                    feeStructure.id = this.generateId();
                    feeStructure.createdAt = new Date().toISOString();
                    structures.push(feeStructure);
                }
                
                return this.set('feeStructure', structures);
            }
            
            deleteFeeStructure(id) {
                const structures = this.getFeeStructure();
                const filtered = structures.filter(f => f.id !== id);
                return this.set('feeStructure', filtered);
            }
            
            // Timetable methods
            getTimetable() {
                return this.get('timetable') || [];
            }
            
            saveTimetable(timetable) {
                const timetables = this.getTimetable();
                if (timetable.id) {
                    const index = timetables.findIndex(t => t.id === timetable.id);
                    if (index !== -1) {
                        timetables[index] = timetable;
                    }
                } else {
                    timetable.id = this.generateId();
                    timetable.createdAt = new Date().toISOString();
                    timetables.push(timetable);
                }
                
                return this.set('timetable', timetables);
            }
            
            deleteTimetable(id) {
                const timetables = this.getTimetable();
                const filtered = timetables.filter(t => t.id !== id);
                return this.set('timetable', filtered);
            }
            
            // Notice methods
            getNotices() {
                return this.get('notices') || [];
            }
            
            saveNotice(notice) {
                const notices = this.getNotices();
                if (notice.id) {
                    const index = notices.findIndex(n => n.id === notice.id);
                    if (index !== -1) {
                        notices[index] = notice;
                    }
                } else {
                    notice.id = this.generateId();
                    notice.date = new Date().toISOString();
                    notice.createdAt = new Date().toISOString();
                    notices.unshift(notice);
                }
                
                return this.set('notices', notices);
            }
            
            deleteNotice(id) {
                const notices = this.getNotices();
                const filtered = notices.filter(n => n.id !== id);
                return this.set('notices', filtered);
            }
            
            // Initialize sample data
            initSampleData() {
                // Only initialize if data is empty
                if (this.getStudents().length > 0) return;
                
                const sampleStudents = [
                    {
                        id: 'stu1',
                        admissionNo: 'STU001',
                        name: 'John Smith',
                        class: '10',
                        section: 'A',
                        rollNo: '1',
                        gender: 'Male',
                        dob: '2007-05-15',
                        parentName: 'Michael Smith',
                        phone: '555-0101',
                        address: '123 Main Street, City',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'stu2',
                        admissionNo: 'STU002',
                        name: 'Emma Johnson',
                        class: '10',
                        section: 'A',
                        rollNo: '2',
                        gender: 'Female',
                        dob: '2007-08-22',
                        parentName: 'Sarah Johnson',
                        phone: '555-0102',
                        address: '456 Oak Avenue, City',
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'stu3',
                        admissionNo: 'STU003',
                        name: 'David Wilson',
                        class: '9',
                        section: 'B',
                        rollNo: '1',
                        gender: 'Male',
                        dob: '2008-03-10',
                        parentName: 'Robert Wilson',
                        phone: '555-0103',
                        address: '789 Pine Road, City',
                        createdAt: new Date().toISOString()
                    }
                ];
                
                sampleStudents.forEach(student => this.saveStudent(student));
                
                // Sample teachers
                const sampleTeachers = [
                    {
                        id: 'tch1',
                        employeeId: 'TCH001',
                        name: 'Dr. Robert Miller',
                        email: 'robert.miller@school.edu',
                        phone: '555-0201',
                        subject: 'Mathematics',
                        classes: ['10', '11', '12'],
                        qualification: 'PhD in Mathematics',
                        experience: '15 years',
                        joinedDate: '2010-06-01'
                    },
                    {
                        id: 'tch2',
                        employeeId: 'TCH002',
                        name: 'Ms. Jennifer Taylor',
                        email: 'jennifer.taylor@school.edu',
                        phone: '555-0202',
                        subject: 'English Literature',
                        classes: ['9', '10', '11'],
                        qualification: 'MA in English',
                        experience: '10 years',
                        joinedDate: '2015-08-15'
                    }
                ];
                
                sampleTeachers.forEach(teacher => this.saveTeacher(teacher));
                
                // Sample classes
                const sampleClasses = [
                    { id: 'cls1', name: 'Class 10', sections: ['A', 'B', 'C'], subjects: ['Math', 'Science', 'English'] },
                    { id: 'cls2', name: 'Class 9', sections: ['A', 'B'], subjects: ['Math', 'Science', 'English', 'Social'] },
                    { id: 'cls3', name: 'Class 8', sections: ['A', 'B', 'C'], subjects: ['Math', 'Science', 'English'] }
                ];
                
                sampleClasses.forEach(cls => this.saveClass(cls));
                
                // Sample subjects
                const sampleSubjects = [
                    { id: 'sub1', name: 'Mathematics', code: 'MATH101', teacher: 'Dr. Robert Miller' },
                    { id: 'sub2', name: 'Science', code: 'SCI101', teacher: 'Dr. Sarah Johnson' },
                    { id: 'sub3', name: 'English', code: 'ENG101', teacher: 'Ms. Jennifer Taylor' }
                ];
                
                sampleSubjects.forEach(subject => this.saveSubject(subject));
                
                // Sample fee structure
                const sampleFeeStructure = [
                    { id: 'fee1', class: '10', term: 'Annual', amount: 50000, description: 'Annual Fee' },
                    { id: 'fee2', class: '9', term: 'Annual', amount: 45000, description: 'Annual Fee' },
                    { id: 'fee3', class: '8', term: 'Annual', amount: 40000, description: 'Annual Fee' }
                ];
                
                sampleFeeStructure.forEach(fee => this.saveFeeStructure(fee));
                
                // Sample exams
                const sampleExams = [
                    { id: 'exam1', name: 'Unit Test 1', class: '10', subject: 'Mathematics', date: '2024-04-15', maxMarks: 100 },
                    { id: 'exam2', name: 'Unit Test 1', class: '10', subject: 'Science', date: '2024-04-16', maxMarks: 100 }
                ];
                
                sampleExams.forEach(exam => this.saveExam(exam));
                
                // Sample timetable
                const sampleTimetable = [
                    { 
                        id: 'tt1', 
                        class: '10', 
                        section: 'A',
                        periods: [
                            { day: 'Monday', period1: 'Math', period2: 'Science', period3: 'English', period4: 'PE', period5: 'History' },
                            { day: 'Tuesday', period1: 'Science', period2: 'Math', period3: 'PE', period4: 'English', period5: 'Geography' },
                            { day: 'Wednesday', period1: 'English', period2: 'Math', period3: 'Science', period4: 'Art', period5: 'Music' },
                            { day: 'Thursday', period1: 'PE', period2: 'English', period3: 'Math', period4: 'Science', period5: 'History' },
                            { day: 'Friday', period1: 'Science', period2: 'PE', period3: 'English', period4: 'Math', period5: 'Geography' }
                        ]
                    }
                ];
                
                sampleTimetable.forEach(tt => this.saveTimetable(tt));
                
                // Sample notices
                const sampleNotices = [
                    {
                        id: 'notice1',
                        title: 'Annual Sports Day',
                        date: new Date().toISOString(),
                        content: 'Annual Sports Day will be held on December 15th. All students are required to participate.',
                        priority: 'important',
                        audience: ['students', 'teachers', 'parents']
                    },
                    {
                        id: 'notice2',
                        title: 'Parent-Teacher Meeting',
                        date: new Date(Date.now() - 86400000).toISOString(),
                        content: 'Parent-teacher meeting for classes 9-12 will be held on Saturday at 10 AM.',
                        priority: 'warning',
                        audience: ['parents', 'teachers']
                    }
                ];
                
                sampleNotices.forEach(notice => this.saveNotice(notice));
                
                // Sample attendance
                const today = new Date().toISOString().split('T')[0];
                const sampleAttendance = {
                    id: 'att1',
                    date: today,
                    class: '10',
                    section: 'A',
                    students: [
                        { studentId: 'stu1', name: 'John Smith', rollNo: '1', status: 'present' },
                        { studentId: 'stu2', name: 'Emma Johnson', rollNo: '2', status: 'present' }
                    ]
                };
                
                this.saveAttendance(sampleAttendance);
            }
            
            // Get statistics for dashboard
            getDashboardStats() {
                const students = this.getStudents();
                const teachers = this.getTeachers();
                const classes = this.getClasses();
                const attendance = this.getAttendance();
                const fees = this.getFees();
                const notices = this.getNotices();
                
                const today = new Date().toISOString().split('T')[0];
                const todayAttendance = attendance.filter(a => a.date === today);
                const pendingFees = fees.filter(f => f.status === 'pending').length;
                
                return {
                    totalStudents: students.length,
                    totalTeachers: teachers.length,
                    totalClasses: classes.length,
                    todayAttendance: todayAttendance.length,
                    pendingFees: pendingFees,
                    activeNotices: notices.length
                };
            }
        }

        // Create global storage instance
        window.storage = new SchoolERPStorage();

        // ============================================
        // FIXED UI Management System
        // ============================================
        class SchoolERPUI {
            constructor() {
                this.currentPage = 'dashboard';
                this.currentAttendance = {
                    date: new Date().toISOString().split('T')[0],
                    class: '',
                    section: '',
                    students: []
                };
                this.initUI();
                this.setupAutoLock();
            }
            
            setupAutoLock() {
                let idleTime = 0;
                const settings = storage.get('settings');
                const autoLockMinutes = settings.autoLockMinutes || 15;
                
                const idleInterval = setInterval(() => {
                    idleTime++;
                    if (idleTime > autoLockMinutes) {
                        if (settings.autoLock) {
                            this.lockSystem();
                            idleTime = 0;
                        }
                    }
                }, 60000);
                
                const resetIdleTime = () => idleTime = 0;
                document.addEventListener('mousemove', resetIdleTime);
                document.addEventListener('keypress', resetIdleTime);
                document.addEventListener('click', resetIdleTime);
                document.addEventListener('touchstart', resetIdleTime);
            }
            
            initUI() {
                this.initEventListeners();
                this.updateDateTime();
                this.loadPage('dashboard');
                this.applyTheme();
                
                setInterval(() => this.updateDateTime(), 60000);
            }
            
            initEventListeners() {
                // Sidebar toggle
                document.getElementById('sidebarToggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('collapsed');
                });
                
                // Navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = link.getAttribute('data-page');
                        this.loadPage(page);
                        
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                    });
                });
                
                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });
                
                // Lock button
                document.getElementById('lockBtn').addEventListener('click', () => {
                    this.lockSystem();
                });
                
                // Export button
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.showExportModal();
                });
                
                // Import button
                document.getElementById('importBtn').addEventListener('click', () => {
                    this.showImportModal();
                });
                
                // Settings button
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.loadPage('settings');
                });
                
                // PIN lock system
                document.getElementById('unlockBtn').addEventListener('click', () => {
                    this.unlockSystem();
                });
                
                document.getElementById('pinField').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.unlockSystem();
                    }
                });
                
                document.getElementById('resetPinBtn').addEventListener('click', () => {
                    this.resetPin();
                });
            }
            
            updateDateTime() {
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                };
                const dateTimeString = now.toLocaleDateString('en-US', options);
                document.getElementById('currentDateTime').textContent = dateTimeString;
            }
            
            applyTheme() {
                const settings = storage.get('settings');
                if (settings.theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    document.body.classList.remove('dark-mode');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
                }
            }
            
            toggleTheme() {
                const settings = storage.get('settings');
                settings.theme = settings.theme === 'light' ? 'dark' : 'light';
                storage.set('settings', settings);
                this.applyTheme();
                this.showToast({ type: 'success', message: `Switched to ${settings.theme} mode` });
            }
            
            lockSystem() {
                document.getElementById('lockScreen').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('pinField').value = '';
                document.getElementById('pinField').focus();
            }
            
            unlockSystem() {
                const pinInput = document.getElementById('pinField').value;
                const settings = storage.get('settings');
                
                if (pinInput === settings.pin) {
                    document.getElementById('lockScreen').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'flex';
                    this.showToast({ type: 'success', message: 'System unlocked' });
                } else {
                    this.showToast({ type: 'error', message: 'Incorrect PIN' });
                    document.getElementById('pinField').value = '';
                    document.getElementById('pinField').focus();
                }
            }
            
            resetPin() {
                const settings = storage.get('settings');
                settings.pin = '1234';
                storage.set('settings', settings);
                this.showToast({ type: 'success', message: 'PIN reset to 1234' });
                document.getElementById('pinField').value = '';
                document.getElementById('pinField').focus();
            }
            
            loadPage(page) {
                this.currentPage = page;
                
                document.querySelectorAll('.page').forEach(p => {
                    p.classList.remove('active');
                    p.style.display = 'none';
                });
                
                const pageElement = document.getElementById(`${page}Page`);
                if (pageElement) {
                    pageElement.style.display = 'block';
                    pageElement.classList.add('active');
                    this.loadPageContent(page);
                }
                
                const settings = storage.get('settings');
                document.getElementById('schoolName').textContent = settings.schoolName;
                document.getElementById('academicYear').textContent = `Academic Year: ${settings.academicYear}`;
            }
            
            loadPageContent(page) {
                switch(page) {
                    case 'dashboard':
                        this.loadDashboard();
                        break;
                    case 'students':
                        this.loadStudents();
                        break;
                    case 'teachers':
                        this.loadTeachers();
                        break;
                    case 'classes':
                        this.loadClasses();
                        break;
                    case 'attendance':
                        this.loadAttendance();
                        break;
                    case 'exams':
                        this.loadExams();
                        break;
                    case 'fees':
                        this.loadFees();
                        break;
                    case 'timetable':
                        this.loadTimetable();
                        break;
                    case 'notices':
                        this.loadNotices();
                        break;
                    case 'settings':
                        this.loadSettings();
                        break;
                }
            }
            
            loadDashboard() {
                const stats = storage.getDashboardStats();
                const students = storage.getStudents();
                const notices = storage.getNotices();
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Dashboard</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addStudentBtn">
                                <i class="fas fa-user-plus"></i> Add Student
                            </button>
                            <button class="btn btn-success" id="markAttendanceBtn">
                                <i class="fas fa-clipboard-check"></i> Mark Attendance
                            </button>
                        </div>
                    </div>
                    
                    <div class="cards-container">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Total Students</h3>
                                <div class="card-icon students">
                                    <i class="fas fa-user-graduate"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.totalStudents}</div>
                            <div class="card-change positive">
                                <i class="fas fa-arrow-up"></i> ${stats.totalStudents} enrolled
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Total Teachers</h3>
                                <div class="card-icon teachers">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.totalTeachers}</div>
                            <div class="card-change positive">
                                <i class="fas fa-arrow-up"></i> ${stats.totalTeachers} active
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Today's Attendance</h3>
                                <div class="card-icon attendance">
                                    <i class="fas fa-clipboard-check"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.todayAttendance}</div>
                            <div class="card-change ${stats.todayAttendance > 0 ? 'positive' : 'warning'}">
                                ${stats.todayAttendance > 0 ? '<i class="fas fa-arrow-up"></i> Marked' : '<i class="fas fa-clock"></i> Pending'}
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Pending Fees</h3>
                                <div class="card-icon fees">
                                    <i class="fas fa-money-check-alt"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.pendingFees}</div>
                            <div class="card-change ${stats.pendingFees > 0 ? 'negative' : 'positive'}">
                                ${stats.pendingFees > 0 ? '<i class="fas fa-exclamation-circle"></i> Due' : '<i class="fas fa-check-circle"></i> Clear'}
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Active Notices</h3>
                                <div class="card-icon notices">
                                    <i class="fas fa-bullhorn"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.activeNotices}</div>
                            <div class="card-change info">
                                <i class="fas fa-bell"></i> Active
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Total Classes</h3>
                                <div class="card-icon classes">
                                    <i class="fas fa-school"></i>
                                </div>
                            </div>
                            <div class="card-value">${stats.totalClasses}</div>
                            <div class="card-change positive">
                                <i class="fas fa-arrow-up"></i> Running
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Students</h3>
                            <div class="table-controls">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchStudents" placeholder="Search students...">
                                </div>
                                <button class="btn btn-primary btn-sm" id="viewAllStudents">
                                    <i class="fas fa-list"></i> View All
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="studentsTable">
                                <thead>
                                    <tr>
                                        <th>Admission No.</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Section</th>
                                        <th>Roll No.</th>
                                        <th>Parent Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${students.slice(0, 5).map(student => `
                                        <tr>
                                            <td>${student.admissionNo}</td>
                                            <td><strong>${student.name}</strong></td>
                                            <td><span class="badge badge-primary">${student.class}</span></td>
                                            <td>${student.section}</td>
                                            <td>${student.rollNo}</td>
                                            <td>${student.phone}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm view-student" data-id="${student.id}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-primary btn-sm edit-student" data-id="${student.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${students.length === 0 ? `
                                        <tr>
                                            <td colspan="7" class="empty-state">
                                                <i class="fas fa-user-graduate"></i>
                                                <p>No students found. Add your first student!</p>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Notices</h3>
                            <div class="table-controls">
                                <button class="btn btn-primary btn-sm" id="addNoticeBtn">
                                    <i class="fas fa-plus"></i> Add Notice
                                </button>
                            </div>
                        </div>
                        <div class="notices-list">
                            ${notices.slice(0, 3).map(notice => `
                                <div class="notice-card ${notice.priority || ''}">
                                    <div class="notice-header">
                                        <h4 class="notice-title">${notice.title}</h4>
                                        <span class="notice-date">${new Date(notice.date).toLocaleDateString()}</span>
                                    </div>
                                    <div class="notice-content">
                                        ${notice.content}
                                    </div>
                                </div>
                            `).join('')}
                            ${notices.length === 0 ? `
                                <div class="empty-state">
                                    <i class="fas fa-bullhorn"></i>
                                    <p>No notices yet. Add your first notice!</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.getElementById('dashboardPage').innerHTML = html;
                
                // Add event listeners for dashboard buttons
                document.getElementById('addStudentBtn')?.addEventListener('click', () => this.showStudentForm());
                document.getElementById('markAttendanceBtn')?.addEventListener('click', () => this.loadPage('attendance'));
                document.getElementById('viewAllStudents')?.addEventListener('click', () => this.loadPage('students'));
                document.getElementById('addNoticeBtn')?.addEventListener('click', () => this.showNoticeForm());
                
                // Add event listeners for student actions
                document.querySelectorAll('.view-student').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showStudentDetails(id);
                    });
                });
                
                document.querySelectorAll('.edit-student').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showStudentForm(id);
                    });
                });
                
                // Search functionality
                document.getElementById('searchStudents')?.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#studentsTable tbody tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
            }
            
            loadStudents() {
                const students = storage.getStudents();
                const classes = storage.getClasses();
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Students Management</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addNewStudentBtn">
                                <i class="fas fa-user-plus"></i> Add Student
                            </button>
                            <button class="btn btn-success" id="exportStudentsBtn">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">All Students (${students.length})</h3>
                            <div class="table-controls">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchAllStudents" placeholder="Search students...">
                                </div>
                                <select class="form-control" id="filterClass" style="width: 150px;">
                                    <option value="">All Classes</option>
                                    ${[...new Set(students.map(s => s.class))].sort((a, b) => a - b).map(cls => `
                                        <option value="${cls}">Class ${cls}</option>
                                    `).join('')}
                                </select>
                                <select class="form-control" id="filterSection" style="width: 150px;">
                                    <option value="">All Sections</option>
                                    ${[...new Set(students.map(s => s.section))].filter(Boolean).map(sec => `
                                        <option value="${sec}">Section ${sec}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Admission No.</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Section</th>
                                        <th>Roll No.</th>
                                        <th>Gender</th>
                                        <th>Date of Birth</th>
                                        <th>Parent Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${students.map(student => `
                                        <tr>
                                            <td><strong>${student.admissionNo}</strong></td>
                                            <td>${student.name}</td>
                                            <td><span class="badge badge-primary">${student.class}</span></td>
                                            <td>${student.section}</td>
                                            <td>${student.rollNo}</td>
                                            <td>${student.gender}</td>
                                            <td>${student.dob ? new Date(student.dob).toLocaleDateString() : ''}</td>
                                            <td>${student.phone}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm view-student-btn" data-id="${student.id}" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-primary btn-sm edit-student-btn" data-id="${student.id}" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm delete-student-btn" data-id="${student.id}" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${students.length === 0 ? `
                                        <tr>
                                            <td colspan="9" class="empty-state">
                                                <i class="fas fa-user-graduate"></i>
                                                <p>No students found. Add your first student!</p>
                                                <button class="btn btn-primary" id="addFirstStudentBtn" style="margin-top: 1rem;">
                                                    <i class="fas fa-user-plus"></i> Add Student
                                                </button>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('studentsPage').innerHTML = html;
                
                // Add event listeners
                document.getElementById('addNewStudentBtn')?.addEventListener('click', () => this.showStudentForm());
                document.getElementById('exportStudentsBtn')?.addEventListener('click', () => this.exportStudents());
                document.getElementById('addFirstStudentBtn')?.addEventListener('click', () => this.showStudentForm());
                
                // Filter functionality
                document.getElementById('searchAllStudents')?.addEventListener('input', (e) => {
                    this.filterStudentsTable();
                });
                
                document.getElementById('filterClass')?.addEventListener('change', () => {
                    this.filterStudentsTable();
                });
                
                document.getElementById('filterSection')?.addEventListener('change', () => {
                    this.filterStudentsTable();
                });
                
                // Student action buttons
                document.querySelectorAll('.view-student-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showStudentDetails(id);
                    });
                });
                
                document.querySelectorAll('.edit-student-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showStudentForm(id);
                    });
                });
                
                document.querySelectorAll('.delete-student-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.deleteStudent(id);
                    });
                });
            }
            
            filterStudentsTable() {
                const searchTerm = document.getElementById('searchAllStudents')?.value.toLowerCase() || '';
                const filterClass = document.getElementById('filterClass')?.value || '';
                const filterSection = document.getElementById('filterSection')?.value || '';
                
                const rows = document.querySelectorAll('#studentsPage tbody tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 2) return;
                    
                    const name = cells[1]?.textContent.toLowerCase() || '';
                    const studentClass = cells[2]?.textContent || '';
                    const section = cells[3]?.textContent || '';
                    
                    const matchesSearch = name.includes(searchTerm) || 
                                        cells[0]?.textContent.toLowerCase().includes(searchTerm);
                    const matchesClass = !filterClass || studentClass.includes(filterClass);
                    const matchesSection = !filterSection || section === filterSection;
                    
                    row.style.display = matchesSearch && matchesClass && matchesSection ? '' : 'none';
                });
            }
            
            showStudentForm(studentId = null) {
                const students = storage.getStudents();
                let student = null;
                
                if (studentId) {
                    student = students.find(s => s.id === studentId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="studentModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${student ? 'Edit Student' : 'Add New Student'}</h3>
                                <button class="modal-close" id="closeStudentModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="studentForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Admission Number *</label>
                                            <input type="text" class="form-control" id="admissionNo" 
                                                   value="${student?.admissionNo || ''}" 
                                                   ${student ? 'readonly' : ''}
                                                   required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Roll Number *</label>
                                            <input type="text" class="form-control" id="rollNo" 
                                                   value="${student?.rollNo || ''}" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Full Name *</label>
                                            <input type="text" class="form-control" id="studentName" 
                                                   value="${student?.name || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Gender *</label>
                                            <select class="form-control" id="gender" required>
                                                <option value="">Select Gender</option>
                                                <option value="Male" ${student?.gender === 'Male' ? 'selected' : ''}>Male</option>
                                                <option value="Female" ${student?.gender === 'Female' ? 'selected' : ''}>Female</option>
                                                <option value="Other" ${student?.gender === 'Other' ? 'selected' : ''}>Other</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Class *</label>
                                            <select class="form-control" id="studentClass" required>
                                                <option value="">Select Class</option>
                                                ${[...new Set(students.map(s => s.class))].sort((a, b) => a - b).map(cls => `
                                                    <option value="${cls}" ${student?.class == cls ? 'selected' : ''}>Class ${cls}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Section *</label>
                                            <input type="text" class="form-control" id="section" 
                                                   value="${student?.section || 'A'}" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Date of Birth</label>
                                            <input type="date" class="form-control" id="dob" 
                                                   value="${student?.dob || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Parent/Guardian Name</label>
                                            <input type="text" class="form-control" id="parentName" 
                                                   value="${student?.parentName || ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Contact Number</label>
                                            <input type="tel" class="form-control" id="phone" 
                                                   value="${student?.phone || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="email" 
                                                   value="${student?.email || ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Address</label>
                                        <textarea class="form-control" id="address" rows="2">${student?.address || ''}</textarea>
                                    </div>
                                    
                                    <input type="hidden" id="studentId" value="${student?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelStudentBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveStudentBtn">
                                    ${student ? 'Update Student' : 'Save Student'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeStudentModal').addEventListener('click', () => {
                    document.getElementById('studentModalOverlay').remove();
                });
                
                document.getElementById('cancelStudentBtn').addEventListener('click', () => {
                    document.getElementById('studentModalOverlay').remove();
                });
                
                document.getElementById('saveStudentBtn').addEventListener('click', () => {
                    this.saveStudent();
                });
                
                // Close on overlay click
                document.getElementById('studentModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'studentModalOverlay') {
                        document.getElementById('studentModalOverlay').remove();
                    }
                });
                
                // Enter key support in form
                document.getElementById('studentForm')?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && e.target.type !== 'textarea') {
                        e.preventDefault();
                        this.saveStudent();
                    }
                });
            }
            
            saveStudent() {
                const student = {
                    id: document.getElementById('studentId').value || null,
                    admissionNo: document.getElementById('admissionNo').value,
                    name: document.getElementById('studentName').value,
                    class: document.getElementById('studentClass').value,
                    section: document.getElementById('section').value,
                    rollNo: document.getElementById('rollNo').value,
                    gender: document.getElementById('gender').value,
                    dob: document.getElementById('dob').value,
                    parentName: document.getElementById('parentName').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value
                };
                
                // Validation
                if (!student.admissionNo || !student.name || !student.class || !student.section || !student.rollNo || !student.gender) {
                    this.showToast({ type: 'error', message: 'Please fill all required fields' });
                    return;
                }
                
                if (storage.saveStudent(student)) {
                    this.showToast({ type: 'success', message: `Student ${student.id ? 'updated' : 'added'} successfully` });
                    document.getElementById('studentModalOverlay').remove();
                    this.loadPage(this.currentPage);
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save student' });
                }
            }
            
            showStudentDetails(studentId) {
                const student = storage.getStudents().find(s => s.id === studentId);
                if (!student) return;
                
                const modalHtml = `
                    <div class="modal-overlay" id="studentDetailsModal">
                        <div class="modal" style="max-width: 800px;">
                            <div class="modal-header">
                                <h3 class="modal-title">Student Details</h3>
                                <button class="modal-close" id="closeDetailsModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="profile-header">
                                    <div class="profile-avatar">
                                        ${student.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                    </div>
                                    <div class="profile-info">
                                        <h2>${student.name}</h2>
                                        <p><strong>Admission No:</strong> ${student.admissionNo}</p>
                                        <p><strong>Class:</strong> ${student.class} - Section ${student.section}</p>
                                        <p><strong>Roll No:</strong> ${student.rollNo}</p>
                                        <p><strong>Gender:</strong> ${student.gender}</p>
                                    </div>
                                </div>
                                
                                <div class="profile-tabs">
                                    <button class="tab-btn active" data-tab="personal">Personal Info</button>
                                    <button class="tab-btn" data-tab="academic">Academic</button>
                                    <button class="tab-btn" data-tab="fees">Fees</button>
                                    <button class="tab-btn" data-tab="attendance">Attendance</button>
                                </div>
                                
                                <div class="tab-content active" id="personalTab">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Date of Birth</label>
                                            <p>${student.dob ? new Date(student.dob).toLocaleDateString() : 'Not specified'}</p>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Age</label>
                                            <p>${student.dob ? this.calculateAge(student.dob) : 'N/A'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Parent/Guardian</label>
                                        <p>${student.parentName || 'Not specified'}</p>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Contact Number</label>
                                            <p>${student.phone || 'Not specified'}</p>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Email</label>
                                            <p>${student.email || 'Not specified'}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Address</label>
                                        <p>${student.address || 'Not specified'}</p>
                                    </div>
                                </div>
                                
                                <div class="tab-content" id="academicTab">
                                    <h4>Academic Information</h4>
                                    <p>Academic details will be displayed here.</p>
                                </div>
                                
                                <div class="tab-content" id="feesTab">
                                    <h4>Fee Details</h4>
                                    <p>Fee payment history will be displayed here.</p>
                                </div>
                                
                                <div class="tab-content" id="attendanceTab">
                                    <h4>Attendance Record</h4>
                                    <p>Attendance statistics will be displayed here.</p>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="closeDetailsBtn">Close</button>
                                <button class="btn btn-primary" id="editStudentDetailsBtn" data-id="${student.id}">
                                    <i class="fas fa-edit"></i> Edit Student
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Tab functionality
                document.querySelectorAll('#studentDetailsModal .tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tab = e.target.getAttribute('data-tab');
                        
                        // Update active tab
                        document.querySelectorAll('#studentDetailsModal .tab-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        // Show corresponding content
                        document.querySelectorAll('#studentDetailsModal .tab-content').forEach(content => {
                            content.classList.remove('active');
                        });
                        document.getElementById(`${tab}Tab`).classList.add('active');
                    });
                });
                
                // Close buttons
                document.getElementById('closeDetailsModal').addEventListener('click', () => {
                    document.getElementById('studentDetailsModal').remove();
                });
                
                document.getElementById('closeDetailsBtn').addEventListener('click', () => {
                    document.getElementById('studentDetailsModal').remove();
                });
                
                document.getElementById('editStudentDetailsBtn').addEventListener('click', () => {
                    document.getElementById('studentDetailsModal').remove();
                    this.showStudentForm(studentId);
                });
                
                // Close on overlay click
                document.getElementById('studentDetailsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'studentDetailsModal') {
                        document.getElementById('studentDetailsModal').remove();
                    }
                });
            }
            
            calculateAge(dob) {
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                return age + ' years';
            }
            
            deleteStudent(studentId) {
                if (!confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                    return;
                }
                
                if (storage.deleteStudent(studentId)) {
                    this.showToast({ type: 'success', message: 'Student deleted successfully' });
                    this.loadPage(this.currentPage);
                } else {
                    this.showToast({ type: 'error', message: 'Failed to delete student' });
                }
            }
            
            exportStudents() {
                const students = storage.getStudents();
                const csv = this.convertToCSV(students);
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `students-export-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast({ type: 'success', message: 'Students exported successfully' });
            }
            
            convertToCSV(data) {
                if (data.length === 0) return '';
                
                const headers = Object.keys(data[0]);
                const csvRows = [];
                
                csvRows.push(headers.join(','));
                
                for (const row of data) {
                    const values = headers.map(header => {
                        const escaped = ('' + row[header]).replace(/"/g, '""');
                        return `"${escaped}"`;
                    });
                    csvRows.push(values.join(','));
                }
                
                return csvRows.join('\n');
            }
            
            loadTeachers() {
                const teachers = storage.getTeachers();
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Teachers Management</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addTeacherBtn">
                                <i class="fas fa-user-plus"></i> Add Teacher
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">All Teachers (${teachers.length})</h3>
                            <div class="table-controls">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchTeachers" placeholder="Search teachers...">
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Name</th>
                                        <th>Subject</th>
                                        <th>Classes</th>
                                        <th>Qualification</th>
                                        <th>Experience</th>
                                        <th>Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${teachers.map(teacher => `
                                        <tr>
                                            <td><strong>${teacher.employeeId}</strong></td>
                                            <td>${teacher.name}</td>
                                            <td><span class="badge badge-primary">${teacher.subject}</span></td>
                                            <td>${Array.isArray(teacher.classes) ? teacher.classes.join(', ') : teacher.classes}</td>
                                            <td>${teacher.qualification || 'N/A'}</td>
                                            <td>${teacher.experience || 'N/A'}</td>
                                            <td>${teacher.phone || 'N/A'}<br><small>${teacher.email || ''}</small></td>
                                            <td>
                                                <button class="btn btn-primary btn-sm edit-teacher-btn" data-id="${teacher.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm delete-teacher-btn" data-id="${teacher.id}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${teachers.length === 0 ? `
                                        <tr>
                                            <td colspan="8" class="empty-state">
                                                <i class="fas fa-chalkboard-teacher"></i>
                                                <p>No teachers found. Add your first teacher!</p>
                                                <button class="btn btn-primary" id="addFirstTeacherBtn" style="margin-top: 1rem;">
                                                    <i class="fas fa-user-plus"></i> Add Teacher
                                                </button>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('teachersPage').innerHTML = html;
                
                // Add event listeners
                document.getElementById('addTeacherBtn')?.addEventListener('click', () => this.showTeacherForm());
                document.getElementById('addFirstTeacherBtn')?.addEventListener('click', () => this.showTeacherForm());
                
                // Search functionality
                document.getElementById('searchTeachers')?.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#teachersPage tbody tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
                
                // Teacher action buttons
                document.querySelectorAll('.edit-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showTeacherForm(id);
                    });
                });
                
                document.querySelectorAll('.delete-teacher-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.deleteTeacher(id);
                    });
                });
            }
            
            showTeacherForm(teacherId = null) {
                const teachers = storage.getTeachers();
                let teacher = null;
                
                if (teacherId) {
                    teacher = teachers.find(t => t.id === teacherId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="teacherModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${teacher ? 'Edit Teacher' : 'Add New Teacher'}</h3>
                                <button class="modal-close" id="closeTeacherModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="teacherForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Employee ID *</label>
                                            <input type="text" class="form-control" id="employeeId" 
                                                   value="${teacher?.employeeId || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Full Name *</label>
                                            <input type="text" class="form-control" id="teacherName" 
                                                   value="${teacher?.name || ''}" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Subject *</label>
                                            <input type="text" class="form-control" id="subject" 
                                                   value="${teacher?.subject || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Classes Assigned</label>
                                            <input type="text" class="form-control" id="classes" 
                                                   value="${Array.isArray(teacher?.classes) ? teacher.classes.join(', ') : teacher?.classes || ''}"
                                                   placeholder="e.g., 10, 11, 12">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="teacherEmail" 
                                                   value="${teacher?.email || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="teacherPhone" 
                                                   value="${teacher?.phone || ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Qualification</label>
                                            <input type="text" class="form-control" id="qualification" 
                                                   value="${teacher?.qualification || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Experience</label>
                                            <input type="text" class="form-control" id="experience" 
                                                   value="${teacher?.experience || ''}" 
                                                   placeholder="e.g., 5 years">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Joining Date</label>
                                        <input type="date" class="form-control" id="joinedDate" 
                                               value="${teacher?.joinedDate || ''}">
                                    </div>
                                    
                                    <input type="hidden" id="teacherId" value="${teacher?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelTeacherBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveTeacherBtn">
                                    ${teacher ? 'Update Teacher' : 'Save Teacher'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeTeacherModal').addEventListener('click', () => {
                    document.getElementById('teacherModalOverlay').remove();
                });
                
                document.getElementById('cancelTeacherBtn').addEventListener('click', () => {
                    document.getElementById('teacherModalOverlay').remove();
                });
                
                document.getElementById('saveTeacherBtn').addEventListener('click', () => {
                    this.saveTeacher();
                });
                
                // Close on overlay click
                document.getElementById('teacherModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'teacherModalOverlay') {
                        document.getElementById('teacherModalOverlay').remove();
                    }
                });
            }
            
            saveTeacher() {
                const teacher = {
                    id: document.getElementById('teacherId').value || null,
                    employeeId: document.getElementById('employeeId').value,
                    name: document.getElementById('teacherName').value,
                    subject: document.getElementById('subject').value,
                    classes: document.getElementById('classes').value.split(',').map(c => c.trim()).filter(c => c),
                    email: document.getElementById('teacherEmail').value,
                    phone: document.getElementById('teacherPhone').value,
                    qualification: document.getElementById('qualification').value,
                    experience: document.getElementById('experience').value,
                    joinedDate: document.getElementById('joinedDate').value
                };
                
                // Validation
                if (!teacher.employeeId || !teacher.name || !teacher.subject) {
                    this.showToast({ type: 'error', message: 'Please fill all required fields' });
                    return;
                }
                
                if (storage.saveTeacher(teacher)) {
                    this.showToast({ type: 'success', message: `Teacher ${teacher.id ? 'updated' : 'added'} successfully` });
                    document.getElementById('teacherModalOverlay').remove();
                    this.loadPage('teachers');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save teacher' });
                }
            }
            
            deleteTeacher(teacherId) {
                if (!confirm('Are you sure you want to delete this teacher?')) {
                    return;
                }
                
                if (storage.deleteTeacher(teacherId)) {
                    this.showToast({ type: 'success', message: 'Teacher deleted successfully' });
                    this.loadPage(this.currentPage);
                } else {
                    this.showToast({ type: 'error', message: 'Failed to delete teacher' });
                }
            }
            
            loadClasses() {
                const classes = storage.getClasses();
                const subjects = storage.getSubjects();
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Classes & Subjects</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addClassBtn">
                                <i class="fas fa-plus"></i> Add Class
                            </button>
                            <button class="btn btn-success" id="addSubjectBtn">
                                <i class="fas fa-book"></i> Add Subject
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Classes (${classes.length})</h3>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Class Name</th>
                                        <th>Sections</th>
                                        <th>Subjects</th>
                                        <th>Total Students</th>
                                        <th>Class Teacher</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${classes.map(cls => {
                                        const students = storage.getStudents().filter(s => s.class == cls.name.split(' ')[1]);
                                        return `
                                            <tr>
                                                <td><strong>${cls.name}</strong></td>
                                                <td>
                                                    ${(Array.isArray(cls.sections) ? cls.sections : [cls.sections]).map(sec => `
                                                        <span class="badge badge-secondary">${sec}</span>
                                                    `).join(' ')}
                                                </td>
                                                <td>
                                                    ${(Array.isArray(cls.subjects) ? cls.subjects : [cls.subjects]).slice(0, 3).map(sub => `
                                                        <span class="badge badge-primary">${sub}</span>
                                                    `).join(' ')}
                                                    ${(Array.isArray(cls.subjects) ? cls.subjects.length : 1) > 3 ? '...' : ''}
                                                </td>
                                                <td><strong>${students.length}</strong> students</td>
                                                <td>Not assigned</td>
                                                <td>
                                                    <button class="btn btn-primary btn-sm edit-class-btn" data-id="${cls.id}">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-danger btn-sm delete-class-btn" data-id="${cls.id}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    ${classes.length === 0 ? `
                                        <tr>
                                            <td colspan="6" class="empty-state">
                                                <i class="fas fa-school"></i>
                                                <p>No classes found. Add your first class!</p>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Subjects (${subjects.length})</h3>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Subject Name</th>
                                        <th>Subject Code</th>
                                        <th>Teacher</th>
                                        <th>Classes</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${subjects.map(subject => `
                                        <tr>
                                            <td><strong>${subject.name}</strong></td>
                                            <td>${subject.code || 'N/A'}</td>
                                            <td>${subject.teacher || 'Not assigned'}</td>
                                            <td>
                                                <span class="badge badge-primary">Class 10</span>
                                                <span class="badge badge-primary">Class 11</span>
                                            </td>
                                            <td>
                                                <button class="btn btn-primary btn-sm edit-subject-btn" data-id="${subject.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm delete-subject-btn" data-id="${subject.id}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${subjects.length === 0 ? `
                                        <tr>
                                            <td colspan="5" class="empty-state">
                                                <i class="fas fa-book"></i>
                                                <p>No subjects found. Add your first subject!</p>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('classesPage').innerHTML = html;
                
                // Add event listeners
                document.getElementById('addClassBtn')?.addEventListener('click', () => this.showClassForm());
                document.getElementById('addSubjectBtn')?.addEventListener('click', () => this.showSubjectForm());
                
                // Class action buttons
                document.querySelectorAll('.edit-class-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showClassForm(id);
                    });
                });
                
                document.querySelectorAll('.delete-class-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.deleteClass(id);
                    });
                });
                
                // Subject action buttons
                document.querySelectorAll('.edit-subject-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showSubjectForm(id);
                    });
                });
                
                document.querySelectorAll('.delete-subject-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.deleteSubject(id);
                    });
                });
            }
            
            showClassForm(classId = null) {
                const classes = storage.getClasses();
                let cls = null;
                
                if (classId) {
                    cls = classes.find(c => c.id === classId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="classModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${cls ? 'Edit Class' : 'Add New Class'}</h3>
                                <button class="modal-close" id="closeClassModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="classForm">
                                    <div class="form-group">
                                        <label class="form-label">Class Name *</label>
                                        <input type="text" class="form-control" id="className" 
                                               value="${cls?.name || ''}" 
                                               placeholder="e.g., Class 10" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Sections *</label>
                                        <input type="text" class="form-control" id="sections" 
                                               value="${Array.isArray(cls?.sections) ? cls.sections.join(', ') : cls?.sections || ''}"
                                               placeholder="e.g., A, B, C" required>
                                        <small class="text-muted">Enter sections separated by commas</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Subjects</label>
                                        <input type="text" class="form-control" id="classSubjects" 
                                               value="${Array.isArray(cls?.subjects) ? cls.subjects.join(', ') : cls?.subjects || ''}"
                                               placeholder="e.g., Math, Science, English">
                                        <small class="text-muted">Enter subjects separated by commas</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Class Teacher</label>
                                        <select class="form-control" id="classTeacher">
                                            <option value="">Select Class Teacher</option>
                                            ${storage.getTeachers().map(teacher => `
                                                <option value="${teacher.id}" ${cls?.teacherId === teacher.id ? 'selected' : ''}>
                                                    ${teacher.name} (${teacher.subject})
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <input type="hidden" id="classId" value="${cls?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelClassBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveClassBtn">
                                    ${cls ? 'Update Class' : 'Save Class'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeClassModal').addEventListener('click', () => {
                    document.getElementById('classModalOverlay').remove();
                });
                
                document.getElementById('cancelClassBtn').addEventListener('click', () => {
                    document.getElementById('classModalOverlay').remove();
                });
                
                document.getElementById('saveClassBtn').addEventListener('click', () => {
                    this.saveClass();
                });
                
                // Close on overlay click
                document.getElementById('classModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'classModalOverlay') {
                        document.getElementById('classModalOverlay').remove();
                    }
                });
            }
            
            saveClass() {
                const cls = {
                    id: document.getElementById('classId').value || null,
                    name: document.getElementById('className').value,
                    sections: document.getElementById('sections').value.split(',').map(s => s.trim()).filter(s => s),
                    subjects: document.getElementById('classSubjects').value.split(',').map(s => s.trim()).filter(s => s),
                    teacherId: document.getElementById('classTeacher').value
                };
                
                // Validation
                if (!cls.name || !cls.sections || cls.sections.length === 0) {
                    this.showToast({ type: 'error', message: 'Please fill all required fields' });
                    return;
                }
                
                if (storage.saveClass(cls)) {
                    this.showToast({ type: 'success', message: `Class ${cls.id ? 'updated' : 'added'} successfully` });
                    document.getElementById('classModalOverlay').remove();
                    this.loadPage('classes');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save class' });
                }
            }
            
            deleteClass(classId) {
                if (!confirm('Are you sure you want to delete this class?')) {
                    return;
                }
                
                if (storage.deleteClass(classId)) {
                    this.showToast({ type: 'success', message: 'Class deleted successfully' });
                    this.loadPage(this.currentPage);
                } else {
                    this.showToast({ type: 'error', message: 'Failed to delete class' });
                }
            }
            
            showSubjectForm(subjectId = null) {
                const subjects = storage.getSubjects();
                let subject = null;
                
                if (subjectId) {
                    subject = subjects.find(s => s.id === subjectId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="subjectModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${subject ? 'Edit Subject' : 'Add New Subject'}</h3>
                                <button class="modal-close" id="closeSubjectModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="subjectForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Subject Name *</label>
                                            <input type="text" class="form-control" id="subjectName" 
                                                   value="${subject?.name || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Subject Code</label>
                                            <input type="text" class="form-control" id="subjectCode" 
                                                   value="${subject?.code || ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Teacher</label>
                                        <select class="form-control" id="subjectTeacher">
                                            <option value="">Select Teacher</option>
                                            ${storage.getTeachers().map(teacher => `
                                                <option value="${teacher.id}" ${subject?.teacherId === teacher.id ? 'selected' : ''}>
                                                    ${teacher.name}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" id="subjectDescription" rows="3">${subject?.description || ''}</textarea>
                                    </div>
                                    
                                    <input type="hidden" id="subjectId" value="${subject?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelSubjectBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveSubjectBtn">
                                    ${subject ? 'Update Subject' : 'Save Subject'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeSubjectModal').addEventListener('click', () => {
                    document.getElementById('subjectModalOverlay').remove();
                });
                
                document.getElementById('cancelSubjectBtn').addEventListener('click', () => {
                    document.getElementById('subjectModalOverlay').remove();
                });
                
                document.getElementById('saveSubjectBtn').addEventListener('click', () => {
                    this.saveSubject();
                });
                
                // Close on overlay click
                document.getElementById('subjectModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'subjectModalOverlay') {
                        document.getElementById('subjectModalOverlay').remove();
                    }
                });
            }
            
            saveSubject() {
                const subject = {
                    id: document.getElementById('subjectId').value || null,
                    name: document.getElementById('subjectName').value,
                    code: document.getElementById('subjectCode').value,
                    teacherId: document.getElementById('subjectTeacher').value,
                    description: document.getElementById('subjectDescription').value
                };
                
                // Validation
                if (!subject.name) {
                    this.showToast({ type: 'error', message: 'Please enter subject name' });
                    return;
                }
                
                if (storage.saveSubject(subject)) {
                    this.showToast({ type: 'success', message: `Subject ${subject.id ? 'updated' : 'added'} successfully` });
                    document.getElementById('subjectModalOverlay').remove();
                    this.loadPage('classes');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save subject' });
                }
            }
            
            deleteSubject(subjectId) {
                if (!confirm('Are you sure you want to delete this subject?')) {
                    return;
                }
                
                if (storage.deleteSubject(subjectId)) {
                    this.showToast({ type: 'success', message: 'Subject deleted successfully' });
                    this.loadPage(this.currentPage);
                } else {
                    this.showToast({ type: 'error', message: 'Failed to delete subject' });
                }
            }
            
            loadAttendance() {
                const students = storage.getStudents();
                const classes = [...new Set(students.map(s => s.class))].sort((a, b) => a - b);
                const today = new Date().toISOString().split('T')[0];
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Attendance Management</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="markAttendanceBtn2">
                                <i class="fas fa-clipboard-check"></i> Mark Attendance
                            </button>
                            <button class="btn btn-success" id="viewAttendanceReportBtn">
                                <i class="fas fa-chart-bar"></i> View Report
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Today's Attendance (${today})</h3>
                            <div class="table-controls">
                                <input type="date" class="form-control" id="attendanceDate" value="${today}" style="width: 180px;">
                                <select class="form-control" id="attendanceClass" style="width: 150px;">
                                    <option value="">Select Class</option>
                                    ${classes.map(cls => `
                                        <option value="${cls}">Class ${cls}</option>
                                    `).join('')}
                                </select>
                                <select class="form-control" id="attendanceSection" style="width: 150px;">
                                    <option value="">Select Section</option>
                                    <option value="A">Section A</option>
                                    <option value="B">Section B</option>
                                    <option value="C">Section C</option>
                                </select>
                                <button class="btn btn-primary" id="loadAttendanceBtn">
                                    <i class="fas fa-sync"></i> Load
                                </button>
                            </div>
                        </div>
                        <div id="attendanceContent">
                            <div class="empty-state">
                                <i class="fas fa-clipboard-list"></i>
                                <h3>No Attendance Data</h3>
                                <p>Select a class and section to mark or view attendance</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('attendancePage').innerHTML = html;
                
                // Add event listeners
                document.getElementById('markAttendanceBtn2')?.addEventListener('click', () => {
                    this.showAttendanceForm();
                });
                
                document.getElementById('viewAttendanceReportBtn')?.addEventListener('click', () => {
                    this.showAttendanceReport();
                });
                
                document.getElementById('loadAttendanceBtn')?.addEventListener('click', () => {
                    this.loadAttendanceData();
                });
                
                // Load attendance when date, class, or section changes
                document.getElementById('attendanceDate')?.addEventListener('change', () => {
                    this.loadAttendanceData();
                });
                
                document.getElementById('attendanceClass')?.addEventListener('change', () => {
                    this.loadAttendanceData();
                });
                
                document.getElementById('attendanceSection')?.addEventListener('change', () => {
                    this.loadAttendanceData();
                });
                
                // Auto-load if there are students
                if (students.length > 0) {
                    document.getElementById('attendanceClass').value = students[0].class;
                    document.getElementById('attendanceSection').value = students[0].section;
                    this.loadAttendanceData();
                }
            }
            
            loadAttendanceData() {
                const date = document.getElementById('attendanceDate').value;
                const className = document.getElementById('attendanceClass').value;
                const section = document.getElementById('attendanceSection').value;
                
                if (!className || !section) {
                    return;
                }
                
                const students = storage.getStudents().filter(s => 
                    s.class == className && s.section === section
                );
                
                const existingAttendance = storage.getAttendanceForClass(date, className, section);
                
                let attendanceGrid = '';
                
                if (students.length > 0) {
                    attendanceGrid = `
                        <div class="attendance-grid" id="attendanceGrid">
                            ${students.map(student => {
                                const existingStatus = existingAttendance?.students?.find(s => s.studentId === student.id)?.status || 'absent';
                                return `
                                    <div class="attendance-card ${existingStatus} ${existingStatus === 'present' || existingStatus === 'absent' ? 'selected' : ''}" 
                                         data-id="${student.id}" data-status="${existingStatus}">
                                        <div class="attendance-avatar">
                                            ${student.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                        </div>
                                        <div class="attendance-name">${student.name}</div>
                                        <div class="attendance-status badge ${existingStatus === 'present' ? 'badge-success' : 'badge-danger'}">
                                            ${existingStatus.toUpperCase()}
                                        </div>
                                        <div class="attendance-roll">Roll No: ${student.rollNo}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="margin-top: 2rem; padding: 1.5rem; background-color: var(--bg-primary); border-radius: var(--border-radius);">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                                <div>
                                    <h4>Attendance Summary</h4>
                                    <p>Class ${className} - Section ${section} | Date: ${date}</p>
                                </div>
                                <div style="display: flex; gap: 1rem;">
                                    <button class="btn btn-secondary" id="markAllPresentBtn">
                                        <i class="fas fa-check-circle"></i> Mark All Present
                                    </button>
                                    <button class="btn btn-secondary" id="markAllAbsentBtn">
                                        <i class="fas fa-times-circle"></i> Mark All Absent
                                    </button>
                                    <button class="btn btn-primary" id="saveAttendanceBtn">
                                        <i class="fas fa-save"></i> Save Attendance
                                    </button>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 2rem; margin-top: 1rem;">
                                <div>
                                    <span class="badge badge-success">Present: <span id="presentCount">${students.filter(s => {
                                        const status = existingAttendance?.students?.find(st => st.studentId === s.id)?.status;
                                        return status === 'present';
                                    }).length}</span></span>
                                </div>
                                <div>
                                    <span class="badge badge-danger">Absent: <span id="absentCount">${students.filter(s => {
                                        const status = existingAttendance?.students?.find(st => st.studentId === s.id)?.status;
                                        return status === 'absent';
                                    }).length}</span></span>
                                </div>
                                <div>
                                    <span class="badge badge-warning">Total: ${students.length}</span>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    attendanceGrid = `
                        <div class="empty-state">
                            <i class="fas fa-users-slash"></i>
                            <h3>No Students Found</h3>
                            <p>No students registered in Class ${className} - Section ${section}</p>
                        </div>
                    `;
                }
                
                document.getElementById('attendanceContent').innerHTML = attendanceGrid;
                
                // Add event listeners to attendance cards
                document.querySelectorAll('.attendance-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const currentStatus = card.getAttribute('data-status');
                        const newStatus = currentStatus === 'present' ? 'absent' : 'present';
                        
                        card.setAttribute('data-status', newStatus);
                        card.classList.remove('present', 'absent');
                        card.classList.add(newStatus);
                        card.classList.add('selected');
                        
                        const statusBadge = card.querySelector('.attendance-status');
                        statusBadge.className = `attendance-status badge ${newStatus === 'present' ? 'badge-success' : 'badge-danger'}`;
                        statusBadge.textContent = newStatus.toUpperCase();
                        
                        this.updateAttendanceCount();
                    });
                });
                
                // Add event listeners to action buttons
                document.getElementById('markAllPresentBtn')?.addEventListener('click', () => {
                    document.querySelectorAll('.attendance-card').forEach(card => {
                        card.setAttribute('data-status', 'present');
                        card.classList.remove('absent');
                        card.classList.add('present');
                        card.classList.add('selected');
                        
                        const statusBadge = card.querySelector('.attendance-status');
                        statusBadge.className = 'attendance-status badge badge-success';
                        statusBadge.textContent = 'PRESENT';
                    });
                    this.updateAttendanceCount();
                });
                
                document.getElementById('markAllAbsentBtn')?.addEventListener('click', () => {
                    document.querySelectorAll('.attendance-card').forEach(card => {
                        card.setAttribute('data-status', 'absent');
                        card.classList.remove('present');
                        card.classList.add('absent');
                        card.classList.add('selected');
                        
                        const statusBadge = card.querySelector('.attendance-status');
                        statusBadge.className = 'attendance-status badge badge-danger';
                        statusBadge.textContent = 'ABSENT';
                    });
                    this.updateAttendanceCount();
                });
                
                document.getElementById('saveAttendanceBtn')?.addEventListener('click', () => {
                    this.saveAttendance();
                });
                
                this.updateAttendanceCount();
            }
            
            updateAttendanceCount() {
                const presentCount = document.querySelectorAll('.attendance-card[data-status="present"]').length;
                const absentCount = document.querySelectorAll('.attendance-card[data-status="absent"]').length;
                
                const presentElement = document.getElementById('presentCount');
                const absentElement = document.getElementById('absentCount');
                
                if (presentElement) presentElement.textContent = presentCount;
                if (absentElement) absentElement.textContent = absentCount;
            }
            
            saveAttendance() {
                const date = document.getElementById('attendanceDate').value;
                const className = document.getElementById('attendanceClass').value;
                const section = document.getElementById('attendanceSection').value;
                
                const attendanceCards = document.querySelectorAll('.attendance-card');
                const students = [];
                
                attendanceCards.forEach(card => {
                    const studentId = card.getAttribute('data-id');
                    const status = card.getAttribute('data-status');
                    const studentName = card.querySelector('.attendance-name').textContent;
                    const rollNo = card.querySelector('.attendance-roll').textContent.replace('Roll No: ', '');
                    
                    students.push({
                        studentId: studentId,
                        id: studentId,
                        name: studentName,
                        rollNo: rollNo,
                        status: status
                    });
                });
                
                const attendance = {
                    date: date,
                    class: className,
                    section: section,
                    students: students
                };
                
                if (storage.saveAttendance(attendance)) {
                    this.showToast({ type: 'success', message: `Attendance saved for Class ${className} - Section ${section}` });
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save attendance' });
                }
            }
            
            showAttendanceForm() {
                const students = storage.getStudents();
                const classes = [...new Set(students.map(s => s.class))].sort((a, b) => a - b);
                const today = new Date().toISOString().split('T')[0];
                
                const modalHtml = `
                    <div class="modal-overlay" id="attendanceFormModal">
                        <div class="modal" style="max-width: 800px;">
                            <div class="modal-header">
                                <h3 class="modal-title">Mark Attendance</h3>
                                <button class="modal-close" id="closeAttendanceForm">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Date *</label>
                                        <input type="date" class="form-control" id="newAttendanceDate" 
                                               value="${today}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Class *</label>
                                        <select class="form-control" id="newAttendanceClass" required>
                                            <option value="">Select Class</option>
                                            ${classes.map(cls => `
                                                <option value="${cls}">Class ${cls}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Section *</label>
                                        <select class="form-control" id="newAttendanceSection" required>
                                            <option value="">Select Section</option>
                                            <option value="A">Section A</option>
                                            <option value="B">Section B</option>
                                            <option value="C">Section C</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="attendanceFormStudents" style="margin-top: 2rem;">
                                    <div class="empty-state">
                                        <i class="fas fa-users"></i>
                                        <p>Select class and section to load students</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelAttendanceForm">Cancel</button>
                                <button class="btn btn-primary" id="submitAttendanceForm" disabled>
                                    <i class="fas fa-save"></i> Save Attendance
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Load students when class and section are selected
                const loadStudentsForAttendance = () => {
                    const className = document.getElementById('newAttendanceClass').value;
                    const section = document.getElementById('newAttendanceSection').value;
                    
                    if (!className || !section) {
                        document.getElementById('submitAttendanceForm').disabled = true;
                        return;
                    }
                    
                    const filteredStudents = students.filter(s => 
                        s.class == className && s.section === section
                    );
                    
                    if (filteredStudents.length === 0) {
                        document.getElementById('attendanceFormStudents').innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-users-slash"></i>
                                <p>No students found in Class ${className} - Section ${section}</p>
                            </div>
                        `;
                        document.getElementById('submitAttendanceForm').disabled = true;
                        return;
                    }
                    
                    let studentsHtml = `
                        <h4>Mark Attendance for ${filteredStudents.length} Students</h4>
                        <div class="attendance-grid" style="margin-top: 1rem;">
                            ${filteredStudents.map(student => `
                                <div class="attendance-card present selected" 
                                     data-id="${student.id}" 
                                     data-status="present"
                                     style="cursor: pointer;">
                                    <div class="attendance-avatar">
                                        ${student.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                                    </div>
                                    <div class="attendance-name">${student.name}</div>
                                    <div class="attendance-status badge badge-success">
                                        PRESENT
                                    </div>
                                    <div class="attendance-roll">Roll No: ${student.rollNo}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                            <button class="btn btn-secondary btn-sm" id="markAllPresentFormBtn">
                                <i class="fas fa-check-circle"></i> Mark All Present
                            </button>
                            <button class="btn btn-secondary btn-sm" id="markAllAbsentFormBtn">
                                <i class="fas fa-times-circle"></i> Mark All Absent
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('attendanceFormStudents').innerHTML = studentsHtml;
                    document.getElementById('submitAttendanceForm').disabled = false;
                    
                    // Add event listeners to attendance cards
                    document.querySelectorAll('#attendanceFormStudents .attendance-card').forEach(card => {
                        card.addEventListener('click', () => {
                            const currentStatus = card.getAttribute('data-status');
                            const newStatus = currentStatus === 'present' ? 'absent' : 'present';
                            
                            card.setAttribute('data-status', newStatus);
                            card.classList.remove('present', 'absent');
                            card.classList.add(newStatus);
                            
                            const statusBadge = card.querySelector('.attendance-status');
                            statusBadge.className = `attendance-status badge ${newStatus === 'present' ? 'badge-success' : 'badge-danger'}`;
                            statusBadge.textContent = newStatus.toUpperCase();
                        });
                    });
                    
                    // Add event listeners to action buttons
                    document.getElementById('markAllPresentFormBtn')?.addEventListener('click', () => {
                        document.querySelectorAll('#attendanceFormStudents .attendance-card').forEach(card => {
                            card.setAttribute('data-status', 'present');
                            card.classList.remove('absent');
                            card.classList.add('present');
                            
                            const statusBadge = card.querySelector('.attendance-status');
                            statusBadge.className = 'attendance-status badge badge-success';
                            statusBadge.textContent = 'PRESENT';
                        });
                    });
                    
                    document.getElementById('markAllAbsentFormBtn')?.addEventListener('click', () => {
                        document.querySelectorAll('#attendanceFormStudents .attendance-card').forEach(card => {
                            card.setAttribute('data-status', 'absent');
                            card.classList.remove('present');
                            card.classList.add('absent');
                            
                            const statusBadge = card.querySelector('.attendance-status');
                            statusBadge.className = 'attendance-status badge badge-danger';
                            statusBadge.textContent = 'ABSENT';
                        });
                    });
                };
                
                // Event listeners for form
                document.getElementById('newAttendanceClass').addEventListener('change', loadStudentsForAttendance);
                document.getElementById('newAttendanceSection').addEventListener('change', loadStudentsForAttendance);
                
                document.getElementById('closeAttendanceForm').addEventListener('click', () => {
                    document.getElementById('attendanceFormModal').remove();
                });
                
                document.getElementById('cancelAttendanceForm').addEventListener('click', () => {
                    document.getElementById('attendanceFormModal').remove();
                });
                
                document.getElementById('submitAttendanceForm').addEventListener('click', () => {
                    this.submitAttendanceForm();
                });
                
                // Close on overlay click
                document.getElementById('attendanceFormModal').addEventListener('click', (e) => {
                    if (e.target.id === 'attendanceFormModal') {
                        document.getElementById('attendanceFormModal').remove();
                    }
                });
            }
            
            submitAttendanceForm() {
                const date = document.getElementById('newAttendanceDate').value;
                const className = document.getElementById('newAttendanceClass').value;
                const section = document.getElementById('newAttendanceSection').value;
                
                const attendanceCards = document.querySelectorAll('#attendanceFormStudents .attendance-card');
                const students = [];
                
                attendanceCards.forEach(card => {
                    const studentId = card.getAttribute('data-id');
                    const status = card.getAttribute('data-status');
                    const studentName = card.querySelector('.attendance-name').textContent;
                    const rollNo = card.querySelector('.attendance-roll').textContent.replace('Roll No: ', '');
                    
                    students.push({
                        studentId: studentId,
                        id: studentId,
                        name: studentName,
                        rollNo: rollNo,
                        status: status
                    });
                });
                
                const attendance = {
                    date: date,
                    class: className,
                    section: section,
                    students: students
                };
                
                if (storage.saveAttendance(attendance)) {
                    this.showToast({ type: 'success', message: `Attendance marked for Class ${className} - Section ${section}` });
                    document.getElementById('attendanceFormModal').remove();
                    this.loadPage('attendance');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save attendance' });
                }
            }
            
            showAttendanceReport() {
                const modalHtml = `
                    <div class="modal-overlay" id="attendanceReportModal">
                        <div class="modal" style="max-width: 1000px;">
                            <div class="modal-header">
                                <h3 class="modal-title">Attendance Report</h3>
                                <button class="modal-close" id="closeAttendanceReport">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Class</label>
                                        <select class="form-control" id="reportClass">
                                            <option value="">All Classes</option>
                                            ${[...new Set(storage.getStudents().map(s => s.class))].sort((a, b) => a - b).map(cls => `
                                                <option value="${cls}">Class ${cls}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Section</label>
                                        <select class="form-control" id="reportSection">
                                            <option value="">All Sections</option>
                                            <option value="A">Section A</option>
                                            <option value="B">Section B</option>
                                            <option value="C">Section C</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Month</label>
                                        <select class="form-control" id="reportMonth">
                                            <option value="">All Months</option>
                                            ${Array.from({length: 12}, (_, i) => {
                                                const date = new Date(2024, i, 1);
                                                return `<option value="${i + 1}">${date.toLocaleString('default', { month: 'long' })}</option>`;
                                            }).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <button class="btn btn-primary" id="generateReportBtn">
                                            <i class="fas fa-chart-bar"></i> Generate
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="reportResults" style="margin-top: 2rem;">
                                    <div class="empty-state">
                                        <i class="fas fa-chart-pie"></i>
                                        <p>Select filters and generate report</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="closeReportBtn">Close</button>
                                <button class="btn btn-success" id="exportReportBtn" disabled>
                                    <i class="fas fa-download"></i> Export Report
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Generate report
                document.getElementById('generateReportBtn').addEventListener('click', () => {
                    this.generateAttendanceReport();
                });
                
                // Close buttons
                document.getElementById('closeAttendanceReport').addEventListener('click', () => {
                    document.getElementById('attendanceReportModal').remove();
                });
                
                document.getElementById('closeReportBtn').addEventListener('click', () => {
                    document.getElementById('attendanceReportModal').remove();
                });
                
                // Export report
                document.getElementById('exportReportBtn').addEventListener('click', () => {
                    this.exportAttendanceReport();
                });
                
                // Close on overlay click
                document.getElementById('attendanceReportModal').addEventListener('click', (e) => {
                    if (e.target.id === 'attendanceReportModal') {
                        document.getElementById('attendanceReportModal').remove();
                    }
                });
            }
            
            generateAttendanceReport() {
                const className = document.getElementById('reportClass').value;
                const section = document.getElementById('reportSection').value;
                const month = document.getElementById('reportMonth').value;
                
                const attendance = storage.getAttendance();
                let filteredAttendance = attendance;
                
                if (className) {
                    filteredAttendance = filteredAttendance.filter(a => a.class == className);
                }
                
                if (section) {
                    filteredAttendance = filteredAttendance.filter(a => a.section === section);
                }
                
                if (month) {
                    filteredAttendance = filteredAttendance.filter(a => {
                        const date = new Date(a.date);
                        return (date.getMonth() + 1) == month;
                    });
                }
                
                // Calculate statistics
                const totalDays = filteredAttendance.length;
                let totalPresent = 0;
                let totalAbsent = 0;
                let studentStats = {};
                
                filteredAttendance.forEach(record => {
                    record.students?.forEach(student => {
                        if (!studentStats[student.studentId]) {
                            studentStats[student.studentId] = {
                                name: student.name,
                                rollNo: student.rollNo,
                                present: 0,
                                absent: 0
                            };
                        }
                        
                        if (student.status === 'present') {
                            studentStats[student.studentId].present++;
                            totalPresent++;
                        } else if (student.status === 'absent') {
                            studentStats[student.studentId].absent++;
                            totalAbsent++;
                        }
                    });
                });
                
                const totalRecords = totalPresent + totalAbsent;
                const overallPercentage = totalRecords > 0 ? Math.round((totalPresent / totalRecords) * 100) : 0;
                
                let reportHtml = `
                    <div style="margin-bottom: 2rem;">
                        <h4>Attendance Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Total Days</h3>
                                </div>
                                <div class="card-value">${totalDays}</div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Present</h3>
                                </div>
                                <div class="card-value">${totalPresent}</div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Absent</h3>
                                </div>
                                <div class="card-value">${totalAbsent}</div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Overall %</h3>
                                </div>
                                <div class="card-value">${overallPercentage}%</div>
                            </div>
                        </div>
                    </div>
                `;
                
                if (Object.keys(studentStats).length > 0) {
                    reportHtml += `
                        <div>
                            <h4>Student-wise Attendance</h4>
                            <div class="table-responsive" style="margin-top: 1rem;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Roll No</th>
                                            <th>Student Name</th>
                                            <th>Present</th>
                                            <th>Absent</th>
                                            <th>Attendance %</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.values(studentStats).map(stat => {
                                            const total = stat.present + stat.absent;
                                            const percentage = total > 0 ? Math.round((stat.present / total) * 100) : 0;
                                            const statusClass = percentage >= 75 ? 'badge-success' : percentage >= 60 ? 'badge-warning' : 'badge-danger';
                                            const statusText = percentage >= 75 ? 'Good' : percentage >= 60 ? 'Average' : 'Poor';
                                            
                                            return `
                                                <tr>
                                                    <td>${stat.rollNo}</td>
                                                    <td>${stat.name}</td>
                                                    <td>${stat.present}</td>
                                                    <td>${stat.absent}</td>
                                                    <td><strong>${percentage}%</strong></td>
                                                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                } else {
                    reportHtml += `
                        <div class="empty-state">
                            <i class="fas fa-chart-bar"></i>
                            <p>No attendance data found for the selected filters</p>
                        </div>
                    `;
                }
                
                document.getElementById('reportResults').innerHTML = reportHtml;
                document.getElementById('exportReportBtn').disabled = Object.keys(studentStats).length === 0;
            }
            
            exportAttendanceReport() {
                const reportContent = document.getElementById('reportResults').innerText;
                const blob = new Blob([reportContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance-report-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast({ type: 'success', message: 'Report exported successfully' });
            }
            
            loadExams() {
                const exams = storage.getExams();
                const results = storage.getResults();
                const students = storage.getStudents();
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Exams & Results</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addExamBtn">
                                <i class="fas fa-plus"></i> Add Exam
                            </button>
                            <button class="btn btn-success" id="addResultBtn">
                                <i class="fas fa-file-signature"></i> Add Result
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Upcoming Exams</h3>
                            <div class="table-controls">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchExams" placeholder="Search exams...">
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Exam Name</th>
                                        <th>Class</th>
                                        <th>Subject</th>
                                        <th>Date</th>
                                        <th>Max Marks</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${exams.map(exam => `
                                        <tr>
                                            <td><strong>${exam.name}</strong></td>
                                            <td><span class="badge badge-primary">${exam.class}</span></td>
                                            <td>${exam.subject}</td>
                                            <td>${new Date(exam.date).toLocaleDateString()}</td>
                                            <td>${exam.maxMarks || 100}</td>
                                            <td>
                                                <span class="badge ${new Date(exam.date) > new Date() ? 'badge-warning' : 'badge-success'}">
                                                    ${new Date(exam.date) > new Date() ? 'Upcoming' : 'Completed'}
                                                </span>
                                            </td>
                                            <td>
                                                <button class="btn btn-primary btn-sm edit-exam-btn" data-id="${exam.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm delete-exam-btn" data-id="${exam.id}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${exams.length === 0 ? `
                                        <tr>
                                            <td colspan="7" class="empty-state">
                                                <i class="fas fa-file-alt"></i>
                                                <p>No exams found. Add your first exam!</p>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Results</h3>
                            <div class="table-controls">
                                <select class="form-control" id="filterResultClass" style="width: 150px;">
                                    <option value="">All Classes</option>
                                    ${[...new Set(students.map(s => s.class))].sort((a, b) => a - b).map(cls => `
                                        <option value="${cls}">Class ${cls}</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Exam</th>
                                        <th>Subject</th>
                                        <th>Marks Obtained</th>
                                        <th>Max Marks</th>
                                        <th>Percentage</th>
                                        <th>Grade</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.slice(0, 10).map(result => {
                                        const student = students.find(s => s.id === result.studentId);
                                        const exam = exams.find(e => e.id === result.examId);
                                        const percentage = (result.marksObtained / result.maxMarks) * 100;
                                        let grade = 'F';
                                        let gradeClass = 'grade-f';
                                        
                                        if (percentage >= 90) {
                                            grade = 'A+'; gradeClass = 'grade-a';
                                        } else if (percentage >= 80) {
                                            grade = 'A'; gradeClass = 'grade-a';
                                        } else if (percentage >= 70) {
                                            grade = 'B'; gradeClass = 'grade-b';
                                        } else if (percentage >= 60) {
                                            grade = 'C'; gradeClass = 'grade-c';
                                        } else if (percentage >= 50) {
                                            grade = 'D'; gradeClass = 'grade-d';
                                        }
                                        
                                        return `
                                            <tr>
                                                <td>${student?.name || 'Unknown'}</td>
                                                <td>${exam?.name || 'Unknown'}</td>
                                                <td>${result.subject || exam?.subject || 'N/A'}</td>
                                                <td><strong>${result.marksObtained}</strong></td>
                                                <td>${result.maxMarks}</td>
                                                <td>${percentage.toFixed(1)}%</td>
                                                <td><span class="result-grade ${gradeClass}">${grade}</span></td>
                                                <td>
                                                    <button class="btn btn-primary btn-sm edit-result-btn" data-id="${result.id}">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    ${results.length === 0 ? `
                                        <tr>
                                            <td colspan="8" class="empty-state">
                                                <i class="fas fa-chart-line"></i>
                                                <p>No results found. Add your first result!</p>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('examsPage').innerHTML = html;
                
                // Add event listeners
                document.getElementById('addExamBtn')?.addEventListener('click', () => this.showExamForm());
                document.getElementById('addResultBtn')?.addEventListener('click', () => this.showResultForm());
                
                // Search functionality
                document.getElementById('searchExams')?.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#examsPage .table-container:first-child tbody tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
                
                // Filter results
                document.getElementById('filterResultClass')?.addEventListener('change', (e) => {
                    const filterClass = e.target.value;
                    const rows = document.querySelectorAll('#examsPage .table-container:last-child tbody tr');
                    
                    rows.forEach(row => {
                        const classCell = row.cells[1]?.textContent || '';
                        if (!filterClass || classCell.includes(filterClass)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
                
                // Exam action buttons
                document.querySelectorAll('.edit-exam-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showExamForm(id);
                    });
                });
                
                document.querySelectorAll('.delete-exam-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.deleteExam(id);
                    });
                });
                
                // Result action buttons
                document.querySelectorAll('.edit-result-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showResultForm(id);
                    });
                });
            }
            
            showExamForm(examId = null) {
                const exams = storage.getExams();
                let exam = null;
                
                if (examId) {
                    exam = exams.find(e => e.id === examId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="examModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${exam ? 'Edit Exam' : 'Add New Exam'}</h3>
                                <button class="modal-close" id="closeExamModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="examForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Exam Name *</label>
                                            <input type="text" class="form-control" id="examName" 
                                                   value="${exam?.name || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Exam Type</label>
                                            <select class="form-control" id="examType">
                                                <option value="Unit Test" ${exam?.type === 'Unit Test' ? 'selected' : ''}>Unit Test</option>
                                                <option value="Term Exam" ${exam?.type === 'Term Exam' ? 'selected' : ''}>Term Exam</option>
                                                <option value="Final Exam" ${exam?.type === 'Final Exam' ? 'selected' : ''}>Final Exam</option>
                                                <option value="Quiz" ${exam?.type === 'Quiz' ? 'selected' : ''}>Quiz</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Class *</label>
                                            <select class="form-control" id="examClass" required>
                                                <option value="">Select Class</option>
                                                ${[...new Set(storage.getStudents().map(s => s.class))].sort((a, b) => a - b).map(cls => `
                                                    <option value="${cls}" ${exam?.class == cls ? 'selected' : ''}>Class ${cls}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Subject *</label>
                                            <input type="text" class="form-control" id="examSubject" 
                                                   value="${exam?.subject || ''}" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Exam Date *</label>
                                            <input type="date" class="form-control" id="examDate" 
                                                   value="${exam?.date || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Max Marks</label>
                                            <input type="number" class="form-control" id="maxMarks" 
                                                   value="${exam?.maxMarks || 100}" min="1" max="200">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" id="examDescription" rows="3">${exam?.description || ''}</textarea>
                                    </div>
                                    
                                    <input type="hidden" id="examId" value="${exam?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelExamBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveExamBtn">
                                    ${exam ? 'Update Exam' : 'Save Exam'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeExamModal').addEventListener('click', () => {
                    document.getElementById('examModalOverlay').remove();
                });
                
                document.getElementById('cancelExamBtn').addEventListener('click', () => {
                    document.getElementById('examModalOverlay').remove();
                });
                
                document.getElementById('saveExamBtn').addEventListener('click', () => {
                    this.saveExam();
                });
                
                // Close on overlay click
                document.getElementById('examModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'examModalOverlay') {
                        document.getElementById('examModalOverlay').remove();
                    }
                });
            }
            
            saveExam() {
                const exam = {
                    id: document.getElementById('examId').value || null,
                    name: document.getElementById('examName').value,
                    type: document.getElementById('examType').value,
                    class: document.getElementById('examClass').value,
                    subject: document.getElementById('examSubject').value,
                    date: document.getElementById('examDate').value,
                    maxMarks: parseInt(document.getElementById('maxMarks').value) || 100,
                    description: document.getElementById('examDescription').value
                };
                
                // Validation
                if (!exam.name || !exam.class || !exam.subject || !exam.date) {
                    this.showToast({ type: 'error', message: 'Please fill all required fields' });
                    return;
                }
                
                if (storage.saveExam(exam)) {
                    this.showToast({ type: 'success', message: `Exam ${exam.id ? 'updated' : 'added'} successfully` });
                    document.getElementById('examModalOverlay').remove();
                    this.loadPage('exams');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save exam' });
                }
            }
            
            deleteExam(examId) {
                if (!confirm('Are you sure you want to delete this exam?')) {
                    return;
                }
                
                if (storage.deleteExam(examId)) {
                    this.showToast({ type: 'success', message: 'Exam deleted successfully' });
                    this.loadPage(this.currentPage);
                } else {
                    this.showToast({ type: 'error', message: 'Failed to delete exam' });
                }
            }
            
            showResultForm(resultId = null) {
                const results = storage.getResults();
                const exams = storage.getExams();
                const students = storage.getStudents();
                let result = null;
                
                if (resultId) {
                    result = results.find(r => r.id === resultId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="resultModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${result ? 'Edit Result' : 'Add New Result'}</h3>
                                <button class="modal-close" id="closeResultModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="resultForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Student *</label>
                                            <select class="form-control" id="resultStudent" required>
                                                <option value="">Select Student</option>
                                                ${students.map(student => `
                                                    <option value="${student.id}" ${result?.studentId === student.id ? 'selected' : ''}>
                                                        ${student.name} (Class ${student.class}, Roll: ${student.rollNo})
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Exam *</label>
                                            <select class="form-control" id="resultExam" required>
                                                <option value="">Select Exam</option>
                                                ${exams.map(exam => `
                                                    <option value="${exam.id}" ${result?.examId === exam.id ? 'selected' : ''}>
                                                        ${exam.name} (${exam.subject})
                                                    </option>
                                                `).join('')}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Subject *</label>
                                            <input type="text" class="form-control" id="resultSubject" 
                                                   value="${result?.subject || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Marks Obtained *</label>
                                            <input type="number" class="form-control" id="marksObtained" 
                                                   value="${result?.marksObtained || ''}" step="0.01" min="0" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Max Marks *</label>
                                            <input type="number" class="form-control" id="resultMaxMarks" 
                                                   value="${result?.maxMarks || 100}" min="1" max="200" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Percentage</label>
                                            <input type="text" class="form-control" id="percentage" readonly>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Remarks</label>
                                        <textarea class="form-control" id="resultRemarks" rows="2">${result?.remarks || ''}</textarea>
                                    </div>
                                    
                                    <input type="hidden" id="resultId" value="${result?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelResultBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveResultBtn">
                                    ${result ? 'Update Result' : 'Save Result'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Calculate percentage when marks change
                const calculatePercentage = () => {
                    const marks = parseFloat(document.getElementById('marksObtained').value) || 0;
                    const maxMarks = parseFloat(document.getElementById('resultMaxMarks').value) || 100;
                    
                    if (maxMarks > 0) {
                        const percentage = (marks / maxMarks) * 100;
                        document.getElementById('percentage').value = percentage.toFixed(2) + '%';
                    }
                };
                
                document.getElementById('marksObtained').addEventListener('input', calculatePercentage);
                document.getElementById('resultMaxMarks').addEventListener('input', calculatePercentage);
                
                // Calculate initial percentage
                if (result) {
                    calculatePercentage();
                }
                
                // Event listeners
                document.getElementById('closeResultModal').addEventListener('click', () => {
                    document.getElementById('resultModalOverlay').remove();
                });
                
                document.getElementById('cancelResultBtn').addEventListener('click', () => {
                    document.getElementById('resultModalOverlay').remove();
                });
                
                document.getElementById('saveResultBtn').addEventListener('click', () => {
                    this.saveResult();
                });
                
                // Close on overlay click
                document.getElementById('resultModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'resultModalOverlay') {
                        document.getElementById('resultModalOverlay').remove();
                    }
                });
            }
            
            saveResult() {
                const result = {
                    id: document.getElementById('resultId').value || null,
                    studentId: document.getElementById('resultStudent').value,
                    examId: document.getElementById('resultExam').value,
                    subject: document.getElementById('resultSubject').value,
                    marksObtained: parseFloat(document.getElementById('marksObtained').value) || 0,
                    maxMarks: parseFloat(document.getElementById('resultMaxMarks').value) || 100,
                    remarks: document.getElementById('resultRemarks').value
                };
                
                // Validation
                if (!result.studentId || !result.examId || !result.subject || isNaN(result.marksObtained)) {
                    this.showToast({ type: 'error', message: 'Please fill all required fields' });
                    return;
                }
                
                if (result.marksObtained > result.maxMarks) {
                    this.showToast({ type: 'error', message: 'Marks obtained cannot exceed maximum marks' });
                    return;
                }
                
                if (storage.saveResult(result)) {
                    this.showToast({ type: 'success', message: `Result ${result.id ? 'updated' : 'added'} successfully` });
                    document.getElementById('resultModalOverlay').remove();
                    this.loadPage('exams');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save result' });
                }
            }
            
            loadFees() {
                const fees = storage.getFees();
                const feeStructure = storage.getFeeStructure();
                const students = storage.getStudents();
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Fee Management</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addFeeBtn">
                                <i class="fas fa-plus"></i> Add Fee Payment
                            </button>
                            <button class="btn btn-success" id="manageFeeStructureBtn">
                                <i class="fas fa-cog"></i> Manage Fee Structure
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Fee Structure</h3>
                        </div>
                        <div class="table-responsive">
                            <table class="fee-structure-table">
                                <thead>
                                    <tr>
                                        <th>Class</th>
                                        <th>Term</th>
                                        <th>Amount</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${feeStructure.map(fee => `
                                        <tr>
                                            <td><strong>Class ${fee.class}</strong></td>
                                            <td>${fee.term}</td>
                                            <td class="fee-amount">${fee.amount.toLocaleString()}</td>
                                            <td>${fee.description}</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm edit-fee-structure-btn" data-id="${fee.id}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm delete-fee-structure-btn" data-id="${fee.id}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${feeStructure.length === 0 ? `
                                        <tr>
                                            <td colspan="5" class="empty-state">
                                                <i class="fas fa-money-check-alt"></i>
                                                <p>No fee structure found. Add your first fee structure!</p>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Fee Payments</h3>
                            <div class="table-controls">
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="searchFees" placeholder="Search payments...">
                                </div>
                                <select class="form-control" id="filterFeeStatus" style="width: 150px;">
                                    <option value="">All Status</option>
                                    <option value="paid">Paid</option>
                                    <option value="pending">Pending</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Receipt No.</th>
                                        <th>Student</th>
                                        <th>Class</th>
                                        <th>Amount</th>
                                        <th>Payment Date</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${fees.slice(0, 10).map(fee => {
                                        const student = students.find(s => s.id === fee.studentId);
                                        let statusClass = 'badge-primary';
                                        let statusText = fee.status || 'pending';
                                        
                                        if (statusText === 'paid') {
                                            statusClass = 'badge-success';
                                        } else if (statusText === 'overdue') {
                                            statusClass = 'badge-danger';
                                        } else if (statusText === 'pending') {
                                            statusClass = 'badge-warning';
                                        }
                                        
                                        return `
                                            <tr>
                                                <td><strong>${fee.receiptNo || 'N/A'}</strong></td>
                                                <td>${student?.name || 'Unknown'}</td>
                                                <td>${student?.class || 'N/A'}</td>
                                                <td><strong>${fee.amount?.toLocaleString() || '0'}</strong></td>
                                                <td>${fee.paymentDate ? new Date(fee.paymentDate).toLocaleDateString() : 'N/A'}</td>
                                                <td>${fee.dueDate ? new Date(fee.dueDate).toLocaleDateString() : 'N/A'}</td>
                                                <td><span class="badge ${statusClass}">${statusText.toUpperCase()}</span></td>
                                                <td>
                                                    <button class="btn btn-primary btn-sm edit-fee-btn" data-id="${fee.id}">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-danger btn-sm delete-fee-btn" data-id="${fee.id}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    ${fees.length === 0 ? `
                                        <tr>
                                            <td colspan="8" class="empty-state">
                                                <i class="fas fa-money-bill-wave"></i>
                                                <p>No fee payments found. Add your first fee payment!</p>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('feesPage').innerHTML = html;
                
                // Add event listeners
                document.getElementById('addFeeBtn')?.addEventListener('click', () => this.showFeeForm());
                document.getElementById('manageFeeStructureBtn')?.addEventListener('click', () => this.showFeeStructureForm());
                
                // Search and filter functionality
                document.getElementById('searchFees')?.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const rows = document.querySelectorAll('#feesPage .table-container:last-child tbody tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        row.style.display = text.includes(searchTerm) ? '' : 'none';
                    });
                });
                
                document.getElementById('filterFeeStatus')?.addEventListener('change', (e) => {
                    const filterStatus = e.target.value;
                    const rows = document.querySelectorAll('#feesPage .table-container:last-child tbody tr');
                    
                    rows.forEach(row => {
                        const statusCell = row.cells[6]?.textContent.toLowerCase() || '';
                        if (!filterStatus || statusCell.includes(filterStatus)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
                
                // Fee structure action buttons
                document.querySelectorAll('.edit-fee-structure-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showFeeStructureForm(id);
                    });
                });
                
                document.querySelectorAll('.delete-fee-structure-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.deleteFeeStructure(id);
                    });
                });
                
                // Fee payment action buttons
                document.querySelectorAll('.edit-fee-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showFeeForm(id);
                    });
                });
                
                document.querySelectorAll('.delete-fee-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.deleteFee(id);
                    });
                });
            }
            
            showFeeForm(feeId = null) {
                const fees = storage.getFees();
                const students = storage.getStudents();
                const feeStructure = storage.getFeeStructure();
                let fee = null;
                
                if (feeId) {
                    fee = fees.find(f => f.id === feeId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="feeModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${fee ? 'Edit Fee Payment' : 'Add Fee Payment'}</h3>
                                <button class="modal-close" id="closeFeeModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="feeForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Student *</label>
                                            <select class="form-control" id="feeStudent" required>
                                                <option value="">Select Student</option>
                                                ${students.map(student => {
                                                    const studentFeeStructure = feeStructure.find(f => f.class == student.class);
                                                    const feeAmount = studentFeeStructure?.amount || 0;
                                                    return `
                                                        <option value="${student.id}" ${fee?.studentId === student.id ? 'selected' : ''}>
                                                            ${student.name} (Class ${student.class}) - Fee: ${feeAmount.toLocaleString()}
                                                        </option>
                                                    `;
                                                }).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Receipt Number</label>
                                            <input type="text" class="form-control" id="receiptNo" 
                                                   value="${fee?.receiptNo || `REC${Date.now().toString().slice(-6)}`}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Amount *</label>
                                            <input type="number" class="form-control" id="feeAmount" 
                                                   value="${fee?.amount || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Payment Date *</label>
                                            <input type="date" class="form-control" id="paymentDate" 
                                                   value="${fee?.paymentDate || new Date().toISOString().split('T')[0]}" required>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Due Date</label>
                                            <input type="date" class="form-control" id="dueDate" 
                                                   value="${fee?.dueDate || ''}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Status *</label>
                                            <select class="form-control" id="feeStatus" required>
                                                <option value="pending" ${fee?.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="paid" ${fee?.status === 'paid' ? 'selected' : ''}>Paid</option>
                                                <option value="overdue" ${fee?.status === 'overdue' ? 'selected' : ''}>Overdue</option>
                                                <option value="partial" ${fee?.status === 'partial' ? 'selected' : ''}>Partial</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Payment Method</label>
                                        <select class="form-control" id="paymentMethod">
                                            <option value="">Select Method</option>
                                            <option value="cash" ${fee?.paymentMethod === 'cash' ? 'selected' : ''}>Cash</option>
                                            <option value="cheque" ${fee?.paymentMethod === 'cheque' ? 'selected' : ''}>Cheque</option>
                                            <option value="bank_transfer" ${fee?.paymentMethod === 'bank_transfer' ? 'selected' : ''}>Bank Transfer</option>
                                            <option value="online" ${fee?.paymentMethod === 'online' ? 'selected' : ''}>Online Payment</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Remarks</label>
                                        <textarea class="form-control" id="feeRemarks" rows="2">${fee?.remarks || ''}</textarea>
                                    </div>
                                    
                                    <input type="hidden" id="feeId" value="${fee?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelFeeBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveFeeBtn">
                                    ${fee ? 'Update Payment' : 'Save Payment'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Auto-fill fee amount based on student's class
                document.getElementById('feeStudent')?.addEventListener('change', function() {
                    const studentId = this.value;
                    if (studentId) {
                        const student = students.find(s => s.id === studentId);
                        if (student) {
                            const studentFeeStructure = feeStructure.find(f => f.class == student.class);
                            if (studentFeeStructure) {
                                document.getElementById('feeAmount').value = studentFeeStructure.amount;
                            }
                        }
                    }
                });
                
                // Event listeners
                document.getElementById('closeFeeModal').addEventListener('click', () => {
                    document.getElementById('feeModalOverlay').remove();
                });
                
                document.getElementById('cancelFeeBtn').addEventListener('click', () => {
                    document.getElementById('feeModalOverlay').remove();
                });
                
                document.getElementById('saveFeeBtn').addEventListener('click', () => {
                    this.saveFee();
                });
                
                // Close on overlay click
                document.getElementById('feeModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'feeModalOverlay') {
                        document.getElementById('feeModalOverlay').remove();
                    }
                });
            }
            
            saveFee() {
                const fee = {
                    id: document.getElementById('feeId').value || null,
                    studentId: document.getElementById('feeStudent').value,
                    receiptNo: document.getElementById('receiptNo').value,
                    amount: parseFloat(document.getElementById('feeAmount').value) || 0,
                    paymentDate: document.getElementById('paymentDate').value,
                    dueDate: document.getElementById('dueDate').value || null,
                    status: document.getElementById('feeStatus').value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    remarks: document.getElementById('feeRemarks').value
                };
                
                // Validation
                if (!fee.studentId || !fee.amount || !fee.paymentDate || !fee.status) {
                    this.showToast({ type: 'error', message: 'Please fill all required fields' });
                    return;
                }
                
                if (fee.amount <= 0) {
                    this.showToast({ type: 'error', message: 'Amount must be greater than 0' });
                    return;
                }
                
                if (storage.saveFee(fee)) {
                    this.showToast({ type: 'success', message: `Fee payment ${fee.id ? 'updated' : 'added'} successfully` });
                    document.getElementById('feeModalOverlay').remove();
                    this.loadPage('fees');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save fee payment' });
                }
            }
            
            deleteFee(feeId) {
                if (!confirm('Are you sure you want to delete this fee payment?')) {
                    return;
                }
                
                if (storage.deleteFee(feeId)) {
                    this.showToast({ type: 'success', message: 'Fee payment deleted successfully' });
                    this.loadPage(this.currentPage);
                } else {
                    this.showToast({ type: 'error', message: 'Failed to delete fee payment' });
                }
            }
            
            showFeeStructureForm(feeStructureId = null) {
                const feeStructure = storage.getFeeStructure();
                let feeStruct = null;
                
                if (feeStructureId) {
                    feeStruct = feeStructure.find(f => f.id === feeStructureId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="feeStructureModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${feeStruct ? 'Edit Fee Structure' : 'Add Fee Structure'}</h3>
                                <button class="modal-close" id="closeFeeStructureModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="feeStructureForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Class *</label>
                                            <select class="form-control" id="feeClass" required>
                                                <option value="">Select Class</option>
                                                ${[...new Set(storage.getStudents().map(s => s.class))].sort((a, b) => a - b).map(cls => `
                                                    <option value="${cls}" ${feeStruct?.class == cls ? 'selected' : ''}>Class ${cls}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Term *</label>
                                            <select class="form-control" id="feeTerm" required>
                                                <option value="">Select Term</option>
                                                <option value="Annual" ${feeStruct?.term === 'Annual' ? 'selected' : ''}>Annual</option>
                                                <option value="Term 1" ${feeStruct?.term === 'Term 1' ? 'selected' : ''}>Term 1</option>
                                                <option value="Term 2" ${feeStruct?.term === 'Term 2' ? 'selected' : ''}>Term 2</option>
                                                <option value="Term 3" ${feeStruct?.term === 'Term 3' ? 'selected' : ''}>Term 3</option>
                                                <option value="Monthly" ${feeStruct?.term === 'Monthly' ? 'selected' : ''}>Monthly</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Amount () *</label>
                                            <input type="number" class="form-control" id="structureAmount" 
                                                   value="${feeStruct?.amount || ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Due Date</label>
                                            <input type="date" class="form-control" id="structureDueDate" 
                                                   value="${feeStruct?.dueDate || ''}">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" id="structureDescription" rows="3">${feeStruct?.description || ''}</textarea>
                                    </div>
                                    
                                    <input type="hidden" id="feeStructureId" value="${feeStruct?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelFeeStructureBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveFeeStructureBtn">
                                    ${feeStruct ? 'Update Structure' : 'Save Structure'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeFeeStructureModal').addEventListener('click', () => {
                    document.getElementById('feeStructureModalOverlay').remove();
                });
                
                document.getElementById('cancelFeeStructureBtn').addEventListener('click', () => {
                    document.getElementById('feeStructureModalOverlay').remove();
                });
                
                document.getElementById('saveFeeStructureBtn').addEventListener('click', () => {
                    this.saveFeeStructure();
                });
                
                // Close on overlay click
                document.getElementById('feeStructureModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'feeStructureModalOverlay') {
                        document.getElementById('feeStructureModalOverlay').remove();
                    }
                });
            }
            
            saveFeeStructure() {
                const feeStructure = {
                    id: document.getElementById('feeStructureId').value || null,
                    class: document.getElementById('feeClass').value,
                    term: document.getElementById('feeTerm').value,
                    amount: parseFloat(document.getElementById('structureAmount').value) || 0,
                    dueDate: document.getElementById('structureDueDate').value || null,
                    description: document.getElementById('structureDescription').value
                };
                
                // Validation
                if (!feeStructure.class || !feeStructure.term || !feeStructure.amount) {
                    this.showToast({ type: 'error', message: 'Please fill all required fields' });
                    return;
                }
                
                if (feeStructure.amount <= 0) {
                    this.showToast({ type: 'error', message: 'Amount must be greater than 0' });
                    return;
                }
                
                if (storage.saveFeeStructure(feeStructure)) {
                    this.showToast({ type: 'success', message: `Fee structure ${feeStructure.id ? 'updated' : 'added'} successfully` });
                    document.getElementById('feeStructureModalOverlay').remove();
                    this.loadPage('fees');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save fee structure' });
                }
            }
            
            deleteFeeStructure(feeStructureId) {
                if (!confirm('Are you sure you want to delete this fee structure?')) {
                    return;
                }
                
                if (storage.deleteFeeStructure(feeStructureId)) {
                    this.showToast({ type: 'success', message: 'Fee structure deleted successfully' });
                    this.loadPage(this.currentPage);
                } else {
                    this.showToast({ type: 'error', message: 'Failed to delete fee structure' });
                }
            }
            
            loadTimetable() {
                const timetable = storage.getTimetable();
                const classes = storage.getClasses();
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">School Timetable</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addTimetableBtn">
                                <i class="fas fa-plus"></i> Add Timetable
                            </button>
                            <button class="btn btn-success" id="printTimetableBtn">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Timetable Management</h3>
                            <div class="table-controls">
                                <select class="form-control" id="timetableClass" style="width: 150px;">
                                    <option value="">Select Class</option>
                                    ${classes.map(cls => `
                                        <option value="${cls.name}">${cls.name}</option>
                                    `).join('')}
                                </select>
                                <select class="form-control" id="timetableSection" style="width: 150px;">
                                    <option value="">Select Section</option>
                                    <option value="A">Section A</option>
                                    <option value="B">Section B</option>
                                    <option value="C">Section C</option>
                                </select>
                                <button class="btn btn-primary" id="loadTimetableBtn">
                                    <i class="fas fa-search"></i> Load
                                </button>
                            </div>
                        </div>
                        
                        <div id="timetableContent">
                            <div class="empty-state">
                                <i class="fas fa-calendar-alt"></i>
                                <h3>No Timetable Loaded</h3>
                                <p>Select a class and section to view timetable</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('timetablePage').innerHTML = html;
                
                // Add event listeners
                document.getElementById('addTimetableBtn')?.addEventListener('click', () => this.showTimetableForm());
                document.getElementById('printTimetableBtn')?.addEventListener('click', () => this.printTimetable());
                document.getElementById('loadTimetableBtn')?.addEventListener('click', () => this.loadTimetableData());
                
                // Auto-load if there is timetable data
                if (timetable.length > 0) {
                    document.getElementById('timetableClass').value = timetable[0].class;
                    document.getElementById('timetableSection').value = timetable[0].section;
                    this.loadTimetableData();
                }
            }
            
            loadTimetableData() {
                const className = document.getElementById('timetableClass').value;
                const section = document.getElementById('timetableSection').value;
                
                if (!className || !section) {
                    this.showToast({ type: 'error', message: 'Please select class and section' });
                    return;
                }
                
                const timetable = storage.getTimetable().find(tt => 
                    tt.class == className && tt.section === section
                );
                
                let timetableHtml = '';
                
                if (timetable && timetable.periods && timetable.periods.length > 0) {
                    timetableHtml = `
                        <div style="margin-bottom: 2rem;">
                            <h4>Timetable for ${className} - Section ${section}</h4>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                                <div>
                                    <button class="btn btn-secondary btn-sm" id="prevDayBtn">
                                        <i class="fas fa-chevron-left"></i> Previous
                                    </button>
                                    <button class="btn btn-secondary btn-sm" id="nextDayBtn" style="margin-left: 0.5rem;">
                                        Next <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <div>
                                    <button class="btn btn-primary btn-sm edit-timetable-btn" data-id="${timetable.id}">
                                        <i class="fas fa-edit"></i> Edit Timetable
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="timetable">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Monday</th>
                                        <th>Tuesday</th>
                                        <th>Wednesday</th>
                                        <th>Thursday</th>
                                        <th>Friday</th>
                                        <th>Saturday</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${[1, 2, 3, 4, 5, 6, 7].map(period => `
                                        <tr>
                                            <td class="timetable-period">Period ${period}</td>
                                            ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].map(day => {
                                                const dayData = timetable.periods.find(p => p.day === day);
                                                const subject = dayData ? dayData[`period${period}`] : '';
                                                return `
                                                    <td>
                                                        ${subject ? `
                                                            <div class="timetable-subject">${subject}</div>
                                                            <div class="timetable-teacher">Teacher</div>
                                                        ` : 'Free'}
                                                    </td>
                                                `;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    timetableHtml = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <h3>No Timetable Found</h3>
                            <p>No timetable created for ${className} - Section ${section}</p>
                            <button class="btn btn-primary" id="createTimetableBtn" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> Create Timetable
                            </button>
                        </div>
                    `;
                }
                
                document.getElementById('timetableContent').innerHTML = timetableHtml;
                
                // Add event listeners
                document.getElementById('createTimetableBtn')?.addEventListener('click', () => {
                    this.showTimetableForm(null, className, section);
                });
                
                document.getElementById('edit-timetable-btn')?.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    this.showTimetableForm(id);
                });
            }
            
            showTimetableForm(timetableId = null, className = '', section = '') {
                const timetable = storage.getTimetable();
                let tt = null;
                
                if (timetableId) {
                    tt = timetable.find(t => t.id === timetableId);
                    if (tt) {
                        className = tt.class;
                        section = tt.section;
                    }
                }
                
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const periods = 7;
                
                let timetableFormHtml = '';
                
                if (tt && tt.periods) {
                    timetableFormHtml = days.map(day => {
                        const dayData = tt.periods.find(p => p.day === day) || {};
                        return `
                            <div style="margin-bottom: 2rem; padding: 1rem; background-color: var(--bg-primary); border-radius: var(--border-radius);">
                                <h5 style="margin-bottom: 1rem; color: var(--primary-color);">${day}</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                                    ${Array.from({length: periods}, (_, i) => i + 1).map(period => `
                                        <div>
                                            <label class="form-label">Period ${period}</label>
                                            <input type="text" class="form-control" 
                                                   name="${day.toLowerCase()}_period${period}" 
                                                   value="${dayData[`period${period}`] || ''}" 
                                                   placeholder="Subject">
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    timetableFormHtml = days.map(day => `
                        <div style="margin-bottom: 2rem; padding: 1rem; background-color: var(--bg-primary); border-radius: var(--border-radius);">
                            <h5 style="margin-bottom: 1rem; color: var(--primary-color);">${day}</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
                                ${Array.from({length: periods}, (_, i) => i + 1).map(period => `
                                    <div>
                                        <label class="form-label">Period ${period}</label>
                                        <input type="text" class="form-control" 
                                               name="${day.toLowerCase()}_period${period}" 
                                               value="" 
                                               placeholder="Subject">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="timetableModalOverlay">
                        <div class="modal" style="max-width: 1000px; max-height: 90vh;">
                            <div class="modal-header">
                                <h3 class="modal-title">${tt ? 'Edit Timetable' : 'Create Timetable'}</h3>
                                <button class="modal-close" id="closeTimetableModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="timetableForm">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Class *</label>
                                            <select class="form-control" id="timetableFormClass" required>
                                                <option value="">Select Class</option>
                                                ${[...new Set(storage.getStudents().map(s => s.class))].sort((a, b) => a - b).map(cls => `
                                                    <option value="${cls}" ${className == cls ? 'selected' : ''}>Class ${cls}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Section *</label>
                                            <select class="form-control" id="timetableFormSection" required>
                                                <option value="">Select Section</option>
                                                <option value="A" ${section === 'A' ? 'selected' : ''}>Section A</option>
                                                <option value="B" ${section === 'B' ? 'selected' : ''}>Section B</option>
                                                <option value="C" ${section === 'C' ? 'selected' : ''}>Section C</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 2rem; max-height: 60vh; overflow-y: auto;">
                                        ${timetableFormHtml}
                                    </div>
                                    
                                    <input type="hidden" id="timetableId" value="${tt?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelTimetableBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveTimetableBtn">
                                    ${tt ? 'Update Timetable' : 'Save Timetable'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeTimetableModal').addEventListener('click', () => {
                    document.getElementById('timetableModalOverlay').remove();
                });
                
                document.getElementById('cancelTimetableBtn').addEventListener('click', () => {
                    document.getElementById('timetableModalOverlay').remove();
                });
                
                document.getElementById('saveTimetableBtn').addEventListener('click', () => {
                    this.saveTimetable();
                });
                
                // Close on overlay click
                document.getElementById('timetableModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'timetableModalOverlay') {
                        document.getElementById('timetableModalOverlay').remove();
                    }
                });
            }
            
            saveTimetable() {
                const className = document.getElementById('timetableFormClass').value;
                const section = document.getElementById('timetableFormSection').value;
                
                if (!className || !section) {
                    this.showToast({ type: 'error', message: 'Please select class and section' });
                    return;
                }
                
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
                const periods = 7;
                
                const timetablePeriods = days.map(day => {
                    const periodData = { day: day.charAt(0).toUpperCase() + day.slice(1) };
                    
                    for (let i = 1; i <= periods; i++) {
                        const input = document.querySelector(`input[name="${day}_period${i}"]`);
                        periodData[`period${i}`] = input?.value || '';
                    }
                    
                    return periodData;
                });
                
                const timetable = {
                    id: document.getElementById('timetableId').value || null,
                    class: className,
                    section: section,
                    periods: timetablePeriods
                };
                
                if (storage.saveTimetable(timetable)) {
                    this.showToast({ type: 'success', message: `Timetable ${timetable.id ? 'updated' : 'created'} successfully` });
                    document.getElementById('timetableModalOverlay').remove();
                    this.loadPage('timetable');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save timetable' });
                }
            }
            
            printTimetable() {
                const timetableContent = document.getElementById('timetableContent');
                if (timetableContent) {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                            <head>
                                <title>Timetable Print</title>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 20px; }
                                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                    th, td { border: 1px solid #333; padding: 10px; text-align: center; }
                                    th { background-color: #f0f0f0; }
                                    h2 { color: #333; }
                                    @media print {
                                        body { margin: 0; }
                                    }
                                </style>
                            </head>
                            <body>
                                <h2>School Timetable</h2>
                                ${timetableContent.innerHTML}
                                <script>
                                    window.onload = function() {
                                        window.print();
                                        window.close();
                                    }
                                </script>
                            </body>
                        </html>
                    `);
                    printWindow.document.close();
                }
            }
            
            loadNotices() {
                const notices = storage.getNotices();
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">Notice Board</h1>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="addNoticeBtn2">
                                <i class="fas fa-plus"></i> Add Notice
                            </button>
                        </div>
                    </div>
                    
                    <div class="notices-list" id="noticesList">
                        ${notices.map(notice => `
                            <div class="notice-card ${notice.priority || ''}">
                                <div class="notice-header">
                                    <h4 class="notice-title">${notice.title}</h4>
                                    <span class="notice-date">${new Date(notice.date).toLocaleDateString()}</span>
                                </div>
                                <div class="notice-content">
                                    ${notice.content}
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                                    <span class="badge ${notice.priority === 'important' ? 'badge-danger' : notice.priority === 'warning' ? 'badge-warning' : 'badge-primary'}">
                                        ${notice.priority ? notice.priority.toUpperCase() : 'GENERAL'}
                                    </span>
                                    <div>
                                        <button class="btn btn-primary btn-sm edit-notice-btn" data-id="${notice.id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm delete-notice-btn" data-id="${notice.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        ${notices.length === 0 ? `
                            <div class="empty-state">
                                <i class="fas fa-bullhorn"></i>
                                <p>No notices found. Add your first notice!</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('noticesPage').innerHTML = html;
                
                // Add event listeners
                document.getElementById('addNoticeBtn2')?.addEventListener('click', () => this.showNoticeForm());
                
                // Notice action buttons
                document.querySelectorAll('.edit-notice-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showNoticeForm(id);
                    });
                });
                
                document.querySelectorAll('.delete-notice-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.deleteNotice(id);
                    });
                });
            }
            
            showNoticeForm(noticeId = null) {
                const notices = storage.getNotices();
                let notice = null;
                
                if (noticeId) {
                    notice = notices.find(n => n.id === noticeId);
                }
                
                const modalHtml = `
                    <div class="modal-overlay" id="noticeModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">${notice ? 'Edit Notice' : 'Add New Notice'}</h3>
                                <button class="modal-close" id="closeNoticeModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <form id="noticeForm">
                                    <div class="form-group">
                                        <label class="form-label">Title *</label>
                                        <input type="text" class="form-control" id="noticeTitle" 
                                               value="${notice?.title || ''}" required>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Date</label>
                                            <input type="date" class="form-control" id="noticeDate" 
                                                   value="${notice?.date ? notice.date.split('T')[0] : new Date().toISOString().split('T')[0]}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Priority</label>
                                            <select class="form-control" id="noticePriority">
                                                <option value="">General</option>
                                                <option value="important" ${notice?.priority === 'important' ? 'selected' : ''}>Important</option>
                                                <option value="warning" ${notice?.priority === 'warning' ? 'selected' : ''}>Warning</option>
                                                <option value="info" ${notice?.priority === 'info' ? 'selected' : ''}>Information</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Content *</label>
                                        <textarea class="form-control" id="noticeContent" rows="6" required>${notice?.content || ''}</textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Target Audience</label>
                                        <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                                            <label class="form-check">
                                                <input type="checkbox" name="audience" value="students" 
                                                       ${notice?.audience?.includes('students') ? 'checked' : ''}>
                                                <span class="form-check-label">Students</span>
                                            </label>
                                            <label class="form-check">
                                                <input type="checkbox" name="audience" value="teachers" 
                                                       ${notice?.audience?.includes('teachers') ? 'checked' : ''}>
                                                <span class="form-check-label">Teachers</span>
                                            </label>
                                            <label class="form-check">
                                                <input type="checkbox" name="audience" value="parents" 
                                                       ${notice?.audience?.includes('parents') ? 'checked' : ''}>
                                                <span class="form-check-label">Parents</span>
                                            </label>
                                            <label class="form-check">
                                                <input type="checkbox" name="audience" value="all" 
                                                       ${notice?.audience?.includes('all') ? 'checked' : ''}>
                                                <span class="form-check-label">All</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <input type="hidden" id="noticeId" value="${notice?.id || ''}">
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="cancelNoticeBtn">Cancel</button>
                                <button class="btn btn-primary" id="saveNoticeBtn">
                                    ${notice ? 'Update Notice' : 'Publish Notice'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeNoticeModal').addEventListener('click', () => {
                    document.getElementById('noticeModalOverlay').remove();
                });
                
                document.getElementById('cancelNoticeBtn').addEventListener('click', () => {
                    document.getElementById('noticeModalOverlay').remove();
                });
                
                document.getElementById('saveNoticeBtn').addEventListener('click', () => {
                    this.saveNotice();
                });
                
                // Close on overlay click
                document.getElementById('noticeModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'noticeModalOverlay') {
                        document.getElementById('noticeModalOverlay').remove();
                    }
                });
            }
            
            saveNotice() {
                const audience = [];
                document.querySelectorAll('input[name="audience"]:checked').forEach(checkbox => {
                    audience.push(checkbox.value);
                });
                
                const notice = {
                    id: document.getElementById('noticeId').value || null,
                    title: document.getElementById('noticeTitle').value,
                    date: document.getElementById('noticeDate').value,
                    priority: document.getElementById('noticePriority').value,
                    content: document.getElementById('noticeContent').value,
                    audience: audience.length > 0 ? audience : ['all']
                };
                
                // Validation
                if (!notice.title || !notice.content) {
                    this.showToast({ type: 'error', message: 'Please fill all required fields' });
                    return;
                }
                
                if (storage.saveNotice(notice)) {
                    this.showToast({ type: 'success', message: `Notice ${notice.id ? 'updated' : 'published'} successfully` });
                    document.getElementById('noticeModalOverlay').remove();
                    this.loadPage('notices');
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save notice' });
                }
            }
            
            deleteNotice(noticeId) {
                if (!confirm('Are you sure you want to delete this notice?')) {
                    return;
                }
                
                if (storage.deleteNotice(noticeId)) {
                    this.showToast({ type: 'success', message: 'Notice deleted successfully' });
                    this.loadPage(this.currentPage);
                } else {
                    this.showToast({ type: 'error', message: 'Failed to delete notice' });
                }
            }
            
            loadSettings() {
                const settings = storage.get('settings');
                
                const html = `
                    <div class="page-header">
                        <h1 class="page-title">System Settings</h1>
                    </div>
                    
                    <div class="settings-container">
                        <div class="settings-nav">
                            <ul>
                                <li><a href="#general" class="active" data-section="general">General Settings</a></li>
                                <li><a href="#security" data-section="security">Security</a></li>
                                <li><a href="#backup" data-section="backup">Backup & Restore</a></li>
                                <li><a href="#about" data-section="about">About</a></li>
                            </ul>
                        </div>
                        
                        <div class="settings-content">
                            <div class="settings-section active" id="generalSection">
                                <h3 style="margin-bottom: 1.5rem;">General Settings</h3>
                                <form id="generalSettingsForm">
                                    <div class="form-group">
                                        <label class="form-label">School Name</label>
                                        <input type="text" class="form-control" id="settingsSchoolName" 
                                               value="${settings.schoolName}">
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Academic Year</label>
                                            <input type="text" class="form-control" id="settingsAcademicYear" 
                                                   value="${settings.academicYear}">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Theme</label>
                                            <select class="form-control" id="settingsTheme">
                                                <option value="light" ${settings.theme === 'light' ? 'selected' : ''}>Light</option>
                                                <option value="dark" ${settings.theme === 'dark' ? 'selected' : ''}>Dark</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Auto-lock System (minutes)</label>
                                        <input type="number" class="form-control" id="settingsAutoLockMinutes" 
                                               value="${settings.autoLockMinutes || 15}" min="0" max="60">
                                        <small class="text-muted">Set to 0 to disable auto-lock</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Date Format</label>
                                        <select class="form-control" id="settingsDateFormat">
                                            <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                                            <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                                            <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                                        </select>
                                    </div>
                                    
                                    <button type="button" class="btn btn-primary" id="saveGeneralSettings">
                                        Save Changes
                                    </button>
                                </form>
                            </div>
                            
                            <div class="settings-section" id="securitySection">
                                <h3 style="margin-bottom: 1.5rem;">Security Settings</h3>
                                <form id="securitySettingsForm">
                                    <div class="form-group">
                                        <label class="form-label">Change PIN</label>
                                        <input type="password" class="form-control" id="newPin" 
                                               placeholder="Enter new 4-digit PIN" maxlength="4">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Confirm PIN</label>
                                        <input type="password" class="form-control" id="confirmPin" 
                                               placeholder="Confirm new PIN" maxlength="4">
                                    </div>
                                    
                                    <div class="form-group">
                                        <div class="form-check" style="margin-top: 1rem;">
                                            <input type="checkbox" class="form-check-input" id="enableAutoLock" 
                                                   ${settings.autoLock ? 'checked' : ''}>
                                            <label class="form-check-label" for="enableAutoLock">Enable auto-lock</label>
                                        </div>
                                    </div>
                                    
                                    <button type="button" class="btn btn-primary" id="saveSecuritySettings">
                                        Update Security Settings
                                    </button>
                                </form>
                            </div>
                            
                            <div class="settings-section" id="backupSection">
                                <h3 style="margin-bottom: 1.5rem;">Backup & Restore</h3>
                                
                                <div class="card" style="margin-bottom: 1.5rem;">
                                    <div class="card-header">
                                        <h4 class="card-title">Backup Data</h4>
                                    </div>
                                    <div class="card-body">
                                        <p>Create a backup of all system data. This will download a JSON file containing all your data.</p>
                                        <button class="btn btn-primary" id="backupDataBtn">
                                            <i class="fas fa-download"></i> Create Backup
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card-title">Restore Data</h4>
                                    </div>
                                    <div class="card-body">
                                        <p>Restore data from a previously created backup file.</p>
                                        <div class="form-group">
                                            <label class="form-label">Select Backup File</label>
                                            <input type="file" class="form-control" id="restoreFile" accept=".json">
                                        </div>
                                        <button class="btn btn-success" id="restoreDataBtn" disabled>
                                            <i class="fas fa-upload"></i> Restore Data
                                        </button>
                                        <small class="text-muted" style="display: block; margin-top: 1rem;">
                                            <strong>Warning:</strong> Restoring data will overwrite all existing data.
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="card" style="margin-top: 1.5rem;">
                                    <div class="card-header">
                                        <h4 class="card-title">Reset System</h4>
                                    </div>
                                    <div class="card-body">
                                        <p>Reset all system data to default. This action cannot be undone.</p>
                                        <button class="btn btn-danger" id="resetSystemBtn">
                                            <i class="fas fa-exclamation-triangle"></i> Reset System
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-section" id="aboutSection">
                                <h3 style="margin-bottom: 1.5rem;">About School ERP</h3>
                                
                                <div class="card">
                                    <div class="card-body">
                                        <h4>Offline School Management System</h4>
                                        <p>Version 1.0.0</p>
                                        <p>This is an offline-capable School ERP system that runs entirely in your browser.</p>
                                        
                                        <div style="margin-top: 2rem;">
                                            <h5>Features:</h5>
                                            <ul>
                                                <li>Student Management</li>
                                                <li>Teacher Management</li>
                                                <li>Attendance Tracking</li>
                                                <li>Exam & Results Management</li>
                                                <li>Fee Management</li>
                                                <li>Timetable Management</li>
                                                <li>Notice Board</li>
                                                <li>Offline Storage</li>
                                                <li>Data Export/Import</li>
                                            </ul>
                                        </div>
                                        
                                        <div style="margin-top: 2rem;">
                                            <h5>Storage Information</h5>
                                            <div class="storage-info">
                                                <div class="storage-bar">
                                                    <div class="storage-fill" style="width: ${((storage.getStorageUsagePercentage() || 0).toFixed(2)) + '%'};"></div>
                                                </div>
                                                <small>Local Storage: <span id="settingsStorageUsed">${storage.getStorageUsageKB() || 0}</span> KB used</small>
                                            </div>
                                        </div>
                                        
                                        <div style="margin-top: 2rem;">
                                            <p><strong>Note:</strong> All data is stored locally in your browser. Make regular backups to prevent data loss.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('settingsPage').innerHTML = html;
                
                // Settings navigation
                document.querySelectorAll('.settings-nav a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const section = link.getAttribute('data-section');
                        
                        // Update active link
                        document.querySelectorAll('.settings-nav a').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                        
                        // Show corresponding section
                        document.querySelectorAll('.settings-section').forEach(sec => {
                            sec.classList.remove('active');
                        });
                        document.getElementById(`${section}Section`).classList.add('active');
                    });
                });
                
                // General settings
                document.getElementById('saveGeneralSettings')?.addEventListener('click', () => {
                    this.saveGeneralSettings();
                });
                
                // Security settings
                document.getElementById('saveSecuritySettings')?.addEventListener('click', () => {
                    this.saveSecuritySettings();
                });
                
                // Backup & Restore
                document.getElementById('backupDataBtn')?.addEventListener('click', () => {
                    storage.exportData();
                    this.showToast({ type: 'success', message: 'Backup created successfully' });
                });
                
                document.getElementById('restoreFile')?.addEventListener('change', (e) => {
                    document.getElementById('restoreDataBtn').disabled = !e.target.files.length;
                });
                
                document.getElementById('restoreDataBtn')?.addEventListener('click', () => {
                    const file = document.getElementById('restoreFile').files[0];
                    if (file) {
                        this.restoreBackup(file);
                    }
                });
                
                // Reset system
                document.getElementById('resetSystemBtn')?.addEventListener('click', () => {
                    this.resetSystem();
                });
            }
            
            saveGeneralSettings() {
                const settings = storage.get('settings');
                
                settings.schoolName = document.getElementById('settingsSchoolName').value;
                settings.academicYear = document.getElementById('settingsAcademicYear').value;
                settings.theme = document.getElementById('settingsTheme').value;
                
                const autoLockMinutes = parseInt(document.getElementById('settingsAutoLockMinutes').value) || 0;
                settings.autoLockMinutes = autoLockMinutes;
                settings.autoLock = autoLockMinutes > 0;
                
                if (storage.set('settings', settings)) {
                    this.applyTheme();
                    document.getElementById('schoolName').textContent = settings.schoolName;
                    document.getElementById('academicYear').textContent = `Academic Year: ${settings.academicYear}`;
                    this.showToast({ type: 'success', message: 'General settings saved' });
                } else {
                    this.showToast({ type: 'error', message: 'Failed to save settings' });
                }
            }
            
            saveSecuritySettings() {
                const newPin = document.getElementById('newPin').value;
                const confirmPin = document.getElementById('confirmPin').value;
                
                if (newPin && newPin !== confirmPin) {
                    this.showToast({ type: 'error', message: 'PINs do not match' });
                    return;
                }
                
                if (newPin && newPin.length !== 4) {
                    this.showToast({ type: 'error', message: 'PIN must be 4 digits' });
                    return;
                }
                
                const settings = storage.get('settings');
                
                if (newPin && newPin.length === 4) {
                    settings.pin = newPin;
                }
                
                settings.autoLock = document.getElementById('enableAutoLock').checked;
                
                if (storage.set('settings', settings)) {
                    document.getElementById('newPin').value = '';
                    document.getElementById('confirmPin').value = '';
                    this.showToast({ type: 'success', message: 'Security settings updated' });
                } else {
                    this.showToast({ type: 'error', message: 'Failed to update settings' });
                }
            }
            
            restoreBackup(file) {
                if (!confirm('Restoring backup will overwrite all current data. Continue?')) {
                    return;
                }
                
                storage.importData(file)
                    .then(() => {
                        this.showToast({ type: 'success', message: 'Backup restored successfully' });
                        setTimeout(() => {
                            location.reload(); // Reload to apply restored data
                        }, 1000);
                    })
                    .catch(error => {
                        this.showToast({ type: 'error', message: 'Failed to restore backup: ' + error.message });
                    });
            }
            
            resetSystem() {
                if (!confirm('This will delete all data and reset to factory settings. This action cannot be undone. Continue?')) {
                    return;
                }
                
                // Clear all localStorage items starting with schoolERP_
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('schoolERP_')) {
                        localStorage.removeItem(key);
                    }
                }
                
                // Reinitialize storage
                storage.initStorage();
                
                this.showToast({ type: 'success', message: 'System reset successfully' });
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
            
            showExportModal() {
                const modalHtml = `
                    <div class="modal-overlay" id="exportModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">Export Data</h3>
                                <button class="modal-close" id="closeExportModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="card" style="margin-bottom: 1rem;">
                                    <div class="card-body">
                                        <h5><i class="fas fa-download text-primary"></i> Complete Backup</h5>
                                        <p>Export all system data as a JSON file.</p>
                                        <button class="btn btn-primary" id="exportAllDataBtn">
                                            <i class="fas fa-download"></i> Export All Data
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="card" style="margin-bottom: 1rem;">
                                    <div class="card-body">
                                        <h5><i class="fas fa-user-graduate text-success"></i> Students Data</h5>
                                        <p>Export students list as CSV file.</p>
                                        <button class="btn btn-success" id="exportStudentsDataBtn">
                                            <i class="fas fa-download"></i> Export Students
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-body">
                                        <h5><i class="fas fa-chalkboard-teacher text-warning"></i> Attendance Data</h5>
                                        <p>Export attendance records as CSV file.</p>
                                        <button class="btn btn-warning" id="exportAttendanceDataBtn">
                                            <i class="fas fa-download"></i> Export Attendance
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="closeExportBtn">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Event listeners
                document.getElementById('closeExportModal').addEventListener('click', () => {
                    document.getElementById('exportModalOverlay').remove();
                });
                
                document.getElementById('closeExportBtn').addEventListener('click', () => {
                    document.getElementById('exportModalOverlay').remove();
                });
                
                document.getElementById('exportAllDataBtn').addEventListener('click', () => {
                    storage.exportData();
                    document.getElementById('exportModalOverlay').remove();
                    this.showToast({ type: 'success', message: 'All data exported successfully' });
                });
                
                document.getElementById('exportStudentsDataBtn').addEventListener('click', () => {
                    this.exportStudents();
                    document.getElementById('exportModalOverlay').remove();
                });
                
                document.getElementById('exportAttendanceDataBtn').addEventListener('click', () => {
                    this.exportAttendanceData();
                    document.getElementById('exportModalOverlay').remove();
                });
                
                // Close on overlay click
                document.getElementById('exportModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'exportModalOverlay') {
                        document.getElementById('exportModalOverlay').remove();
                    }
                });
            }
            
            exportAttendanceData() {
                const attendance = storage.getAttendance();
                const csv = this.convertToCSV(attendance);
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance-export-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast({ type: 'success', message: 'Attendance data exported successfully' });
            }
            
            showImportModal() {
                const modalHtml = `
                    <div class="modal-overlay" id="importModalOverlay">
                        <div class="modal">
                            <div class="modal-header">
                                <h3 class="modal-title">Import Data</h3>
                                <button class="modal-close" id="closeImportModal">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="card" style="margin-bottom: 1.5rem;">
                                    <div class="card-body">
                                        <h5><i class="fas fa-file-import text-primary"></i> Import Backup File</h5>
                                        <p>Import a previously exported backup file (JSON format).</p>
                                        <div class="form-group">
                                            <label class="form-label">Select Backup File</label>
                                            <input type="file" class="form-control" id="importBackupFile" accept=".json">
                                        </div>
                                        <button class="btn btn-primary" id="importBackupBtn" disabled>
                                            <i class="fas fa-upload"></i> Import Backup
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="card">
                                    <div class="card-body">
                                        <h5><i class="fas fa-file-csv text-success"></i> Import CSV Data</h5>
                                        <p>Import students or other data from CSV files.</p>
                                        <div class="form-group">
                                            <label class="form-label">Select CSV File</label>
                                            <input type="file" class="form-control" id="importCsvFile" accept=".csv">
                                        </div>
                                        <select class="form-control" id="importDataType" style="margin-bottom: 1rem;">
                                            <option value="students">Students Data</option>
                                            <option value="teachers">Teachers Data</option>
                                        </select>
                                        <button class="btn btn-success" id="importCsvBtn" disabled>
                                            <i class="fas fa-upload"></i> Import CSV
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" id="closeImportBtn">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalContainer').innerHTML = modalHtml;
                
                // Enable/disable import buttons based on file selection
                document.getElementById('importBackupFile')?.addEventListener('change', function() {
                    document.getElementById('importBackupBtn').disabled = !this.files.length;
                });
                
                document.getElementById('importCsvFile')?.addEventListener('change', function() {
                    document.getElementById('importCsvBtn').disabled = !this.files.length;
                });
                
                // Event listeners
                document.getElementById('closeImportModal').addEventListener('click', () => {
                    document.getElementById('importModalOverlay').remove();
                });
                
                document.getElementById('closeImportBtn').addEventListener('click', () => {
                    document.getElementById('importModalOverlay').remove();
                });
                
                document.getElementById('importBackupBtn').addEventListener('click', () => {
                    const file = document.getElementById('importBackupFile').files[0];
                    if (file) {
                        this.restoreBackup(file);
                        document.getElementById('importModalOverlay').remove();
                    }
                });
                
                document.getElementById('importCsvBtn').addEventListener('click', () => {
                    const file = document.getElementById('importCsvFile').files[0];
                    const dataType = document.getElementById('importDataType').value;
                    if (file) {
                        this.importCSV(file, dataType);
                        document.getElementById('importModalOverlay').remove();
                    }
                });
                
                // Close on overlay click
                document.getElementById('importModalOverlay').addEventListener('click', (e) => {
                    if (e.target.id === 'importModalOverlay') {
                        document.getElementById('importModalOverlay').remove();
                    }
                });
            }
            
            importCSV(file, dataType) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csv = event.target.result;
                        const rows = csv.split('\n');
                        const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        
                        let importedCount = 0;
                        
                        for (let i = 1; i < rows.length; i++) {
                            if (!rows[i].trim()) continue;
                            
                            const values = rows[i].split(',').map(v => v.trim().replace(/"/g, ''));
                            const item = {};
                            
                            headers.forEach((header, index) => {
                                if (values[index] !== undefined) {
                                    item[header] = values[index];
                                }
                            });
                            
                            if (dataType === 'students') {
                                // Convert CSV data to student format
                                const student = {
                                    name: item.Name || item.name || '',
                                    admissionNo: item['Admission No'] || item.admissionNo || item['Admission Number'] || '',
                                    class: item.Class || item.class || '',
                                    section: item.Section || item.section || 'A',
                                    rollNo: item['Roll No'] || item.rollNo || item['Roll Number'] || '',
                                    gender: item.Gender || item.gender || '',
                                    dob: item.DOB || item.dob || item['Date of Birth'] || '',
                                    parentName: item['Parent Name'] || item.parentName || item['Guardian Name'] || '',
                                    phone: item.Phone || item.phone || item['Contact Number'] || '',
                                    email: item.Email || item.email || '',
                                    address: item.Address || item.address || ''
                                };
                                
                                if (student.name && student.class) {
                                    storage.saveStudent(student);
                                    importedCount++;
                                }
                            } else if (dataType === 'teachers') {
                                // Convert CSV data to teacher format
                                const teacher = {
                                    name: item.Name || item.name || '',
                                    employeeId: item['Employee ID'] || item.employeeId || '',
                                    subject: item.Subject || item.subject || '',
                                    email: item.Email || item.email || '',
                                    phone: item.Phone || item.phone || '',
                                    qualification: item.Qualification || item.qualification || ''
                                };
                                
                                if (teacher.name && teacher.employeeId) {
                                    storage.saveTeacher(teacher);
                                    importedCount++;
                                }
                            }
                        }
                        
                        this.showToast({ 
                            type: 'success', 
                            message: `Successfully imported ${importedCount} ${dataType} from CSV` 
                        });
                        
                        // Reload current page to show imported data
                        this.loadPage(this.currentPage);
                        
                    } catch (error) {
                        this.showToast({ type: 'error', message: 'Failed to import CSV: ' + error.message });
                    }
                };
                reader.onerror = () => {
                    this.showToast({ type: 'error', message: 'Failed to read CSV file' });
                };
                reader.readAsText(file);
            }
            
            showToast(options) {
                const { type = 'info', message = '', duration = 3000 } = options;
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas ${
                            type === 'success' ? 'fa-check-circle' :
                            type === 'error' ? 'fa-exclamation-circle' :
                            type === 'warning' ? 'fa-exclamation-triangle' :
                            'fa-info-circle'
                        }"></i>
                    </div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                const container = document.getElementById('toastContainer');
                container.appendChild(toast);
                
                // Remove toast after duration
                const removeToast = () => {
                    toast.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                };
                
                // Auto remove
                setTimeout(removeToast, duration);
                
                // Close button
                toast.querySelector('.toast-close').addEventListener('click', removeToast);
            }
        }

        // Add storage usage methods to storage class
        SchoolERPStorage.prototype.getStorageUsageKB = function() {
            let totalBytes = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('schoolERP_')) {
                    const value = localStorage.getItem(key);
                    if (value) {
                        totalBytes += new Blob([value]).size;
                    }
                }
            }
            return Math.round(totalBytes / 1024);
        };
        
        SchoolERPStorage.prototype.getStorageUsagePercentage = function() {
            const usedKB = this.getStorageUsageKB();
            const maxKB = 5120; // 5MB
            return Math.min((usedKB / maxKB) * 100, 100);
        };

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Create global instances
            window.showToast = (options) => {
                if (window.ui) {
                    window.ui.showToast(options);
                }
            };
            
            // Initialize UI
            window.ui = new SchoolERPUI();
            
            // Check if we should show lock screen
            const settings = storage.get('settings');
            if (settings.autoLock) {
                document.getElementById('lockScreen').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            } else {
                document.getElementById('lockScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
            }
            
            // Update storage usage periodically
            setInterval(() => {
                storage.updateStorageUsage();
            }, 30000);
            
            // Add toast animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOutRight {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
